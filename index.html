<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RevoLab Simulator | Industrial Robotics</title>
    
    <!-- Three.js Core & Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/math/ConvexHull.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/ConvexGeometry.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            /* Dark Theme (Default) */
            --bg-app: #0a0a0a;
            --bg-panel: #141414;
            --bg-input: #1f1f1f;
            --border-color: #333333;
            --accent-primary: #ff9100;
            --accent-hover: #ffb74d;
            --accent-dim: rgba(255, 145, 0, 0.15);
            --text-main: #e0e0e0;
            --text-muted: #757575;
            --text-highlight: #ffffff;
            --status-ok: #00e676;
            --status-warn: #ffea00;
            --status-err: #ff1744;
            --viewport-bg: radial-gradient(circle at center, #1a1a1a 0%, #000000 120%);
            
            --font-ui: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
        }

        /* Light Theme Override - Only affects Viewport Background */
        body.light-theme {
            --viewport-bg: radial-gradient(circle at center, #e0e0e0 0%, #a0a0a0 120%);
        }

        * { box-sizing: border-box; user-select: none; }

        body { margin: 0; background-color: var(--bg-app); color: var(--text-main); font-family: var(--font-ui); overflow: hidden; height: 100vh; display: flex; flex-direction: column; transition: background-color 0.3s, color 0.3s; }

        /* Loader Styles */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-app);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s cubic-bezier(0.6, -0.28, 0.735, 0.045);
        }
        
        .logo-container {
            position: relative;
            width: 500px; height: 500px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 40px;
        }

        .logo-ring {
            position: absolute; width: 100%; height: 100%;
            border: 2px solid transparent; border-top-color: var(--accent-primary); border-left-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
        }
        .logo-ring:nth-child(2) {
            width: 70%; height: 70%;
            border: 2px solid transparent; border-bottom-color: #fff; border-right-color: #fff;
            animation: spin 2s linear infinite reverse;
        }

        .loader-bar-bg {
            width: 240px; height: 2px; background: #222;
            position: relative; overflow: hidden; border-radius: 2px;
        }

        .loader-bar-fill {
            position: absolute; top: 0; left: 0; height: 100%; width: 0%;
            background: var(--accent-primary);
            box-shadow: 0 0 10px var(--accent-primary);
            transition: width 0.2s ease-out;
        }

        .loader-status {
            margin-top: 15px;
            font-family: var(--font-mono); font-size: 10px; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
            min-width: 240px; text-align: center;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        #app-container { display: flex; flex-direction: column; width: 100%; height: 100%; opacity: 0; transition: opacity 1s ease; }
        #app-container.visible { opacity: 1; }

        #top-bar {
            height: 50px;
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 20;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            justify-content: space-between;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 180px;
        }
        .header-logo h1 { 
            margin: 0; font-size: 16px; font-weight: 800; letter-spacing: 1px; color: var(--text-main); text-transform: uppercase; display: flex; align-items: center; gap: 8px; 
        }
        .header-logo h1 span {
            font-size: 9px; opacity: 0.5; font-weight: 400; border: 1px solid var(--text-muted); padding: 1px 3px; border-radius: 3px;
        }
        .header-logo h1::before { content: ''; display: block; width: 10px; height: 10px; background: var(--accent-primary); box-shadow: 0 0 8px var(--accent-primary); border-radius: 50%; }

        .toolbar-center {
            display: flex;
            gap: 2px;
            height: 34px;
            background: var(--bg-input);
            padding: 2px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .tool-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 16px; 
            cursor: pointer;
            transition: all 0.2s ease;
            width: 36px;
            height: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .tool-btn:hover { color: var(--text-main); background: rgba(125,125,125,0.1); }
        .tool-btn.active { 
            color: #000;
            background: var(--accent-primary); 
            box-shadow: 0 0 10px var(--accent-dim);
        }
        
        .tool-btn::after {
            content: attr(data-title);
            position: absolute;
            top: 115%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-panel);
            color: var(--text-main);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 1px solid var(--border-color);
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .tool-btn:hover::after { opacity: 1; }

        .toolbar-separator { width:1px; background:var(--border-color); margin:0 4px; height: 60%; align-self: center; }

        #main-area {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            display: flex;
        }

        #viewport { 
            width: 100%; 
            height: 100%; 
            background: var(--viewport-bg);
            transition: background 0.5s;
        }

        #tools-panel-container {
            position: absolute;
            top: 10px;
            left: 10px;
            bottom: 10px;
            width: 300px;
            background: var(--bg-panel);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            z-index: 10;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s, background-color 0.3s;
            transform: translateX(0);
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        /* Transparency adjustment for panel */
        #tools-panel-container { background: rgba(15, 15, 15, 0.95); }
        
        #tools-panel-container.collapsed {
            transform: translateX(-20px);
            opacity: 0;
            pointer-events: none;
        }

        #panel-header {
            height: 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            flex-shrink: 0;
        }

        .panel-title {
            color: var(--text-highlight);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-close-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        .panel-close-btn:hover { color: var(--accent-primary); }

        .panel-scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px;
        }
        
        .panel-scroll-area::-webkit-scrollbar { width: 4px; }
        .panel-scroll-area::-webkit-scrollbar-track { background: transparent; }
        .panel-scroll-area::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .panel { display: none; animation: fadeIn 0.3s; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .control-section { background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; margin-bottom: 12px; transition: background-color 0.3s; }
        /* Slightly more transparent section bg in dark mode for depth */
        .control-section { background: rgba(255,255,255,0.03); }
        
        .section-title { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 8px; }
        label { font-size: 12px; color: var(--text-muted); min-width: 60px; }
        
        input[type="number"], input[type="text"], select { background: var(--bg-app); border: 1px solid var(--border-color); color: var(--text-main); padding: 6px 8px; border-radius: 4px; width: 100%; font-family: var(--font-mono); font-size: 11px; outline: none; transition: border-color 0.2s, background-color 0.3s; }
        input:focus, select:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 1px var(--accent-dim); }
        
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: var(--border-color); border-radius: 2px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--text-main); border: 2px solid var(--bg-panel); border-radius: 50%; cursor: pointer; transition: transform 0.1s, background 0.2s; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); background: var(--accent-primary); }
        
        input[type="color"] { -webkit-appearance: none; border: none; width: 100%; height: 24px; cursor: pointer; background: transparent; padding: 0; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid var(--border-color); border-radius: 4px; }
        
        .collision-warn { animation: flashRed 0.5s infinite; }
        @keyframes flashRed { 0% { background-color: var(--bg-panel); } 50% { background-color: rgba(255, 23, 68, 0.2); } 100% { background-color: var(--bg-panel); } }

        .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-top: 8px; }
        .btn-grid.tri { grid-template-columns: repeat(3, 1fr); }
        button { background: var(--bg-app); border: 1px solid transparent; color: var(--text-main); padding: 8px 12px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 6px; }
        button { background: #252525; }
        button:hover { transform: translateY(-1px); filter: brightness(1.2); }
        button.primary { background: var(--accent-primary); color: #000; }
        button.primary:hover { background: var(--accent-hover); box-shadow: 0 4px 15px var(--accent-dim); }
        button.danger { background: rgba(255, 23, 68, 0.1); color: #ff1744; border-color: rgba(255, 23, 68, 0.3); }
        button.danger:hover { background: rgba(255, 23, 68, 0.2); }

        .editor-wrapper { position: relative; border: 1px solid var(--border-color); background: var(--bg-app); border-radius: 4px; }
        textarea.code-area { width: 100%; height: 300px; background: transparent; border: none; color: var(--accent-hover); font-family: var(--font-mono); font-size: 11px; padding: 10px; resize: vertical; outline: none; line-height: 1.5; }
        
        #plot-overlay { position: absolute; bottom: 20px; right: 20px; width: 300px; background: var(--bg-panel); backdrop-filter: blur(8px); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; pointer-events: auto; box-shadow: 0 5px 20px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 8px; }
        .plot-header { display: flex; justify-content: space-between; align-items: center; }
        .plot-title { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .plot-controls { display: flex; gap: 4px; }
        .plot-controls button { padding: 4px 8px; font-size: 9px; min-width: auto; height: auto; }
        .plot-legend { display: flex; justify-content: space-between; font-size: 9px; font-family: var(--font-mono); color: var(--text-muted); margin-top: 2px; }
        canvas#plot-canvas { width: 100%; height: 100px; background: #000; border-radius: 2px; border: 1px solid var(--border-color); display: block; }

        #hud-container { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; pointer-events: none; z-index: 5; }
        .hud-panel { background: var(--bg-panel); opacity: 0.9; backdrop-filter: blur(8px); border-left: 2px solid var(--accent-primary); padding: 10px 15px; border-radius: 0 4px 4px 0; min-width: 180px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .hud-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .hud-value { font-family: var(--font-mono); font-size: 14px; color: var(--text-highlight); font-weight: 700; }
        .hud-value.accent { color: var(--accent-primary); }

        #toast-area { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 10px; pointer-events: none; z-index: 100; }
        .toast { background: var(--bg-panel); color: var(--text-main); padding: 10px 20px; border-radius: 20px; font-size: 12px; border: 1px solid var(--border-color); box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px; opacity: 0; transform: translateY(10px); animation: popIn 0.3s forwards; }
        @keyframes popIn { to { opacity: 1; transform: translateY(0); } }

        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: center; color: var(--accent-primary); padding: 8px 4px; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        td { padding: 4px; }
        
        #ai-prompt { background: rgba(255, 145, 0, 0.05); border: 1px solid var(--accent-primary); color: var(--text-main); font-family: var(--font-ui); margin-bottom: 8px; }
        #ai-prompt::placeholder { color: var(--text-muted); opacity: 0.7; }
    </style>
</head>
<body>

<div id="loader">
    <div class="logo-container">
        <div class="logo-ring"></div>
        <div class="logo-ring"></div>
        <div style="font-size: 40px; font-weight: 800; color: var(--accent-primary); z-index: 10;">REVOLAB</div>
    </div>
    <div class="loader-bar-bg">
        <div class="loader-bar-fill" id="loader-fill"></div>
    </div>
    <div class="loader-status" id="loader-text">INITIALIZING CORE...</div>
</div>

<div id="app-container">
    <div id="top-bar">
        <div class="header-logo">
            <h1>RevoLab <span>V5.2</span></h1>
        </div>

        <div class="toolbar-center">
            <!-- Setup Group -->
            <button class="tool-btn active" id="btn-setup" onclick="UI.toggleTool('setup')" data-title="Robot Architecture">
                <i class="ph ph-wrench"></i>
            </button>
            <button class="tool-btn" id="btn-env" onclick="UI.toggleTool('env')" data-title="Environment">
                <i class="ph ph-globe"></i>
            </button>
            
            <div class="toolbar-separator"></div>
            
            <!-- Control Group -->
            <button class="tool-btn" id="btn-ik" onclick="UI.toggleTool('ik')" data-title="Inverse Kinematics">
                <i class="ph ph-crosshair"></i>
            </button>
            <button class="tool-btn" id="btn-joints" onclick="UI.toggleTool('joints')" data-title="Joint Control">
                <i class="ph ph-sliders-horizontal"></i>
            </button>
            
            <div class="toolbar-separator"></div>
            
            <!-- Connect Group -->
            <button class="tool-btn" id="btn-connect" onclick="UI.toggleTool('connect')" data-title="Hardware Connect">
                <i class="ph ph-plugs"></i>
            </button>
            <button class="tool-btn" id="btn-export" onclick="UI.toggleTool('export')" data-title="Export Driver">
                <i class="ph ph-file-code"></i>
            </button>
            
            <div class="toolbar-separator"></div>
            
            <!-- Advanced Group -->
            <button class="tool-btn" id="btn-script" onclick="UI.toggleTool('script')" data-title="AI Scripting">
                <i class="ph ph-magic-wand"></i>
            </button>
            <button class="tool-btn" id="btn-ros" onclick="UI.toggleTool('ros')" data-title="ROS Bridge">
                <i class="ph ph-infinity"></i>
            </button>
        </div>
        
        <div style="width: 200px; display:flex; justify-content:flex-end; align-items:center;">
            <span style="font-size:10px; color:var(--text-muted); margin-right:10px;">CONNECTED</span>
            <div style="width:8px; height:8px; background:var(--status-ok); border-radius:50%; box-shadow:0 0 5px var(--status-ok);"></div>
        </div>
    </div>

    <div id="main-area">
        <div id="tools-panel-container">
            <div id="panel-header">
                <span class="panel-title" id="active-panel-title"><i class="ph ph-wrench"></i> Robot Architecture</span>
                <button class="panel-close-btn" onclick="UI.closePanel()" title="Close Panel">
                    <i class="ph ph-x"></i>
                </button>
            </div>

            <div class="panel-scroll-area">
                <!-- 1. SETUP TOOL -->
                <div id="panel-setup" class="panel active">
                    <div class="control-section">
                        <div class="section-title">Model Selection</div>
                        <div class="input-group">
                            <label style="display:block; margin-bottom:5px;">Hardware Preset</label>
                            <select id="preset-sel" onchange="Sim.loadPreset(this.value)">
                                <option value="simple" selected>Simple 3-DOF</option>
                                <option value="ur5">UR5 (Cobot)</option>
                            </select>
                        </div>
                         <div class="btn-grid">
                            <button class="danger" onclick="Sim.hardReset()">Hard Reset</button>
                            <button class="primary" onclick="document.getElementById('urdf-input').click()">Import URDF</button>
                            <input type="file" id="urdf-input" style="display:none" accept=".urdf,.xml" onchange="URDF.handleFile(this)">
                         </div>
                    </div>

                    <div class="control-section" id="dh-section">
                        <div class="section-title">
                            <span>DH Parameters</span>
                            <span style="font-size:9px; color:#555">Modified Denavit-Hartenberg</span>
                        </div>
                        <div style="overflow-x:auto">
                            <table id="dh-table">
                                <thead>
                                    <tr>
                                        <th title="Joint Type">Type</th>
                                        <th title="Link Offset">d</th>
                                        <th title="Link Length">a</th>
                                        <th title="Link Twist">&alpha;</th>
                                        <th title="Joint Offset">Off</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="btn-grid tri" style="margin-top:10px;">
                            <button onclick="Robot.addLink()">+</button>
                            <button onclick="Robot.removeLink()">-</button>
                            <button class="primary" onclick="Robot.rebuild()">Apply</button>
                        </div>
                    </div>
                </div>

                <!-- 2. ENVIRONMENT TOOL -->
                <div id="panel-env" class="panel">
                    <div class="control-section">
                        <div class="section-title">System Theme</div>
                        <div class="btn-grid">
                            <button onclick="UI.setTheme('dark')"><i class="ph ph-moon"></i> Dark</button>
                            <button onclick="UI.setTheme('light')"><i class="ph ph-sun"></i> Light</button>
                        </div>
                        <div style="margin-top:8px; font-size:10px; color:#666; line-height:1.4;">
                            Adjusts viewport lighting and background. UI remains in dark mode.
                        </div>
                    </div>
                    <div class="control-section">
                        <div class="section-title">View Settings</div>
                        <div class="row">
                            <label>Camera</label>
                            <button onclick="Sim.resetCamera()">Reset View</button>
                        </div>
                        <div class="row">
                            <label>Visuals</label>
                            <button onclick="View.toggleFrames()">Toggle Joint Frames</button>
                        </div>
                    </div>
                    <div class="control-section">
                        <div class="section-title">Analysis</div>
                        <div class="row">
                            <label>Workspace</label>
                            <button onclick="Env.toggleWorkspace()">Generate 3D Hull</button>
                        </div>
                    </div>
                </div>

                <!-- 3. INVERSE KINEMATICS TOOL -->
                <div id="panel-ik" class="panel">
                    <div class="control-section">
                        <div class="section-title">Target Coordinate</div>
                        <div class="row" id="ik-controls">
                            <input type="number" id="ik-x" placeholder="X" value="1.0" step="0.1" oninput="Robot.liveIK()">
                            <input type="number" id="ik-y" placeholder="Y" value="1.0" step="0.1" oninput="Robot.liveIK()">
                            <input type="number" id="ik-z" placeholder="Z" value="0.5" step="0.1" oninput="Robot.liveIK()">
                        </div>
                        <div class="btn-grid tri" style="margin-top:10px;" id="jog-controls">
                            <button onmousedown="Robot.startJog('x', 0.05)" onmouseup="Robot.stopJog()">X+</button>
                            <button onmousedown="Robot.startJog('y', 0.05)" onmouseup="Robot.stopJog()">Y+</button>
                            <button onmousedown="Robot.startJog('z', 0.05)" onmouseup="Robot.stopJog()">Z+</button>
                            <button onmousedown="Robot.startJog('x', -0.05)" onmouseup="Robot.stopJog()">X-</button>
                            <button onmousedown="Robot.startJog('y', -0.05)" onmouseup="Robot.stopJog()">Y-</button>
                            <button onmousedown="Robot.startJog('z', -0.05)" onmouseup="Robot.stopJog()">Z-</button>
                        </div>
                        <div id="urdf-ik-warning" style="display:none; color:var(--text-muted); font-size:10px; margin-top:10px; text-align:center;">
                            IK Solver disabled. Using Forward Kinematics only.
                        </div>
                    </div>
                </div>

                <!-- 4. JOINTS TOOL -->
                <div id="panel-joints" class="panel">
                    <div class="control-section">
                        <div class="section-title">Joint Override</div>
                        <div id="joint-sliders"></div>
                    </div>
                    <div class="control-section">
                        <div class="section-title">End Effector</div>
                        <div class="row">
                            <label>Gripper</label>
                            <input type="range" min="0" max="1" step="0.01" value="0" oninput="Robot.setGripper(this.value)">
                        </div>
                    </div>
                </div>

                <!-- 5. CONNECT TOOL -->
                <div id="panel-connect" class="panel">
                    <div class="control-section">
                        <div class="section-title">
                            <span>Serial Connection</span>
                            <span id="serial-status" style="font-size:9px; color:var(--text-muted)">DISCONNECTED</span>
                        </div>
                        <div class="row">
                            <label>USB Port</label>
                            <button class="primary" id="btn-connect" onclick="Serial.connect()">Connect Device</button>
                            <button class="danger" id="btn-disconnect" onclick="Serial.disconnect()" style="display:none">Disconnect</button>
                        </div>
                        <div class="row">
                            <label>Baud Rate</label>
                            <select id="baud-rate">
                                <option value="9600">9600</option>
                                <option value="115200" selected>115200</option>
                                <option value="57600">57600</option>
                                <option value="38400">38400</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 6. EXPORT TOOL -->
                <div id="panel-export" class="panel">
                    <div class="control-section">
                        <div class="section-title">Driver Code Gen</div>
                        <div class="input-group">
                            <select id="code-lang" onchange="CodeGen.generate()">
                                <option value="cpp">C++ (Embedded/Arduino)</option>
                                <option value="python">Python (NumPy)</option>
                            </select>
                        </div>
                        <div class="editor-wrapper" style="margin-top:10px;">
                            <textarea id="export-area" class="code-area" readonly></textarea>
                        </div>
                        <button class="primary" style="margin-top:10px;" onclick="CodeGen.copy()">Copy to Clipboard</button>
                    </div>
                </div>

                <!-- 7. SCRIPT TOOL -->
                <div id="panel-script" class="panel">
                    <div class="control-section" style="border-color: var(--accent-primary);">
                        <div class="section-title" style="color: var(--accent-primary);">‚ú® Gemini Copilot</div>
                        <input type="text" id="ai-prompt" placeholder="e.g., Pick up the crate and stack it at x=0">
                        <button class="primary" onclick="AI.generateScript()">Generate RevoScript ‚ú®</button>
                    </div>

                    <div class="control-section">
                        <div class="section-title">RevoScript Editor</div>
                        <div class="editor-wrapper">
                            <textarea id="script-area" class="code-area" spellcheck="false">
// Pick and Place Demo
SPEED 50
HOME
GRIP 0

// Approach
MOVE 1.2 0.5 0.5
WAIT 500

// Descent
MOVE 1.2 0.1 0.5
WAIT 500
GRIP 1
WAIT 500

// Lift
MOVE 1.2 0.8 0.5
// Move Away
MOVE 0.0 0.8 1.2
// Drop
GRIP 0
HOME</textarea>
                                </div>
                                <div class="btn-grid">
                                    <button class="primary" onclick="Script.run()">Execute</button>
                                    <button class="danger" onclick="Script.stop()">Halt</button>
                                </div>
                            </div>
                            
                            <div class="control-section">
                                <div class="section-title">Telemetry</div>
                                <canvas id="telemetry"></canvas>
                                <div style="display:flex; justify-content:space-between; font-size:9px; color:#555; margin-top:5px;">
                                    <span>T-5s</span>
                                    <span>NOW</span>
                                </div>
                            </div>
                        </div>

                        <!-- 8. ROS TOOL -->
                        <div id="panel-ros" class="panel">
                            <div class="control-section">
                                <div class="section-title">ROS 2 Integration</div>
                                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 350px; text-align: center; border: 1px dashed var(--border-color); border-radius: 4px; background: rgba(0,0,0,0.2);">
                                    <div style="font-size: 32px; margin-bottom: 15px; opacity: 0.6;">üê¢</div>
                                    <div style="font-size: 14px; font-weight: 700; color: var(--text-highlight); margin-bottom: 8px;">ROS Bridge Node</div>
                                    <p style="font-size: 11px; color: var(--text-muted); max-width: 220px; line-height: 1.5; margin-bottom: 20px;">
                                        Native DDS communication, TF tree broadcasting, and URDF export capabilities.
                                    </p>
                                    <div style="padding: 6px 12px; border: 1px solid var(--accent-primary); color: var(--accent-primary); font-size: 10px; border-radius: 20px; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; background: var(--accent-dim);">
                                        Coming Soon
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="viewport">
                    <div id="hud-container">
                        <div class="hud-panel">
                            <div class="hud-label">System Status</div>
                            <div class="hud-value" id="hud-status" style="color:var(--status-ok)">ONLINE</div>
                        </div>
                        <div class="hud-panel">
                            <div class="hud-label">Tool Center Point (TCP)</div>
                            <div class="hud-value accent" id="hud-tcp">0.00, 0.00, 0.00</div>
                        </div>
                        <div class="hud-panel">
                            <div class="hud-label">Joint Velocity (Max)</div>
                            <div class="hud-value" id="hud-vel">0.0 rad/s</div>
                        </div>
                    </div>

                    <div id="plot-overlay">
                        <div class="plot-header">
                            <div class="plot-title">Live Trajectory</div>
                            <div class="plot-controls">
                                <button onclick="View.toggleTrailRecord()" title="Toggle 3D Trail">Trail</button>
                                <button class="danger" onclick="View.clearTrail()" title="Clear 3D">Clr 3D</button>
                                <button class="primary" onclick="Plotter.togglePause()" title="Pause 2D">||</button>
                                <button onclick="Plotter.clear()" title="Clear 2D">Clr 2D</button>
                            </div>
                        </div>
                        <canvas id="plot-canvas"></canvas>
                        <div class="plot-legend">
                            <span style="color:#ff4444">‚ñ† X-Pos</span>
                            <span style="color:#44ff44">‚ñ† Y-Pos</span>
                            <span style="color:#4444ff">‚ñ† Z-Pos</span>
                        </div>
                    </div>

                    <div id="toast-area"></div>
                    
                    <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 9px; color: #444; pointer-events: none;">
                        RevoLab Simulator V5.2 | High-Fidelity Industrial Simulation
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
const RAD2DEG = 180 / Math.PI;
const DEG2RAD = Math.PI / 180;
const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
const apiKey = ""; 

const PRESETS = {
    ur5: [
        { type:'r', d:0.6, a:0, alpha:90, offset:0, min:-360, max:360 }, 
        { type:'r', d:0, a:-0.8, alpha:0, offset:-90, min:-360, max:360 }, 
        { type:'r', d:0, a:-0.6, alpha:0, offset:0, min:-360, max:360 }, 
        { type:'r', d:0.2, a:0, alpha:90, offset:90, min:-360, max:360 }, 
        { type:'r', d:0.2, a:0, alpha:-90, offset:0, min:-360, max:360 }, 
        { type:'r', d:0.2, a:0, alpha:0, offset:0, min:-360, max:360 } 
    ],
    simple: [
        { type:'r', d:0.5, a:0, alpha:90, offset:0, min:-180, max:180 },
        { type:'r', d:0, a:0.5, alpha:0, offset:0, min:-180, max:180 },
        { type:'r', d:0, a:0.5, alpha:0, offset:0, min:-180, max:180 }
    ]
};

const Telemetry = {
    data: [],
    push: function(val) { this.data.push(val); if(this.data.length > 200) this.data.shift(); this.draw(); },
    draw: function() {
        const cvs = document.getElementById('telemetry'); 
        if (!cvs) return;
        const ctx = cvs.getContext('2d');
        if (!ctx) return;
        if (cvs.width !== cvs.offsetWidth || cvs.height !== cvs.offsetHeight) {
            cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
        }
        const w = cvs.width; const h = cvs.height;
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg-input'); ctx.fillRect(0,0,w,h); 
        ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent-primary'); 
        ctx.lineWidth = 2; ctx.beginPath();
        for(let i=0; i<this.data.length; i++) { const x = (i/200)*w; const y = h - (this.data[i] * h * 5); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
        ctx.stroke();
    }
};

const Plotter = {
    canvas: null, ctx: null, dataX: [], dataY: [], dataZ: [], paused: false,
    init: function() { this.canvas = document.getElementById('plot-canvas'); if(!this.canvas) return; this.ctx = this.canvas.getContext('2d'); },
    push: function(x, y, z) {
        if(this.paused) return;
        if(!this.ctx) this.init();
        if(!this.ctx) return;
        this.dataX.push(x); this.dataY.push(y); this.dataZ.push(z);
        if(this.dataX.length > 200) { this.dataX.shift(); this.dataY.shift(); this.dataZ.shift(); }
        this.draw();
    },
    togglePause: function() { this.paused = !this.paused; },
    clear: function() { this.dataX = []; this.dataY = []; this.dataZ = []; },
    draw: function() {
        const cvs = this.canvas; const ctx = this.ctx;
        if(cvs.width !== cvs.offsetWidth || cvs.height !== cvs.offsetHeight) { cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight; }
        const w = cvs.width; const h = cvs.height;
        ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,w,h);
        ctx.strokeStyle = '#222'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
        this.drawSeries(this.dataX, '#ff4444', w, h); this.drawSeries(this.dataY, '#44ff44', w, h); this.drawSeries(this.dataZ, '#4444ff', w, h);
    },
    drawSeries: function(data, color, w, h) {
        if(data.length < 2) return;
        const ctx = this.ctx; ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 1.5;
        const scale = h/4; const mid = h/2; const step = w / 200;
        for(let i=0; i<data.length; i++) { const x = i * step; const y = mid - (data[i] * scale); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
        ctx.stroke();
    }
};

const Serial = {
    port: null, writer: null, connected: false, lastSend: 0,
    connect: async function() {
        if (!navigator.serial) return UI.notify("Web Serial API not supported", "err");
        try {
            this.port = await navigator.serial.requestPort();
            const baud = parseInt(document.getElementById('baud-rate').value);
            await this.port.open({ baudRate: baud });
            this.writer = this.port.writable.getWriter();
            this.connected = true;
            document.getElementById('btn-connect').style.display = 'none';
            document.getElementById('btn-disconnect').style.display = 'inline-block';
            document.getElementById('serial-status').innerText = "CONNECTED";
            document.getElementById('serial-status').style.color = "var(--status-ok)";
            UI.notify("Serial Connected", "ok");
        } catch (e) { UI.notify("Connection Failed", "err"); }
    },
    disconnect: async function() {
        if (this.writer) { await this.writer.releaseLock(); this.writer = null; }
        if (this.port) { await this.port.close(); this.port = null; }
        this.connected = false;
        document.getElementById('btn-connect').style.display = 'inline-block';
        document.getElementById('btn-disconnect').style.display = 'none';
        document.getElementById('serial-status').innerText = "DISCONNECTED";
        document.getElementById('serial-status').style.color = "var(--text-muted)";
        UI.notify("Serial Disconnected", "warn");
    },
    sendThrottled: function(joints) {
        if (!this.connected) return;
        const now = Date.now();
        if (now - this.lastSend > 50) { this.send(joints); this.lastSend = now; }
    },
    send: async function(joints) {
        if (!this.writer) return;
        const data = joints.map(j => j.toFixed(1)).join(',') + ',' + Robot.gripper.toFixed(2) + '\n';
        try { await this.writer.write(new TextEncoder().encode(data)); } catch (e) {}
    }
};

const URDF = {
    parser: new DOMParser(),
    handleFile: function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => this.parse(e.target.result);
            reader.readAsText(input.files[0]);
        }
    },
    parse: function(xmlString) {
        try {
            const xmlDoc = this.parser.parseFromString(xmlString, "text/xml");
            const robotName = xmlDoc.querySelector('robot')?.getAttribute('name') || "urdf_robot";
            UI.notify(`Loading URDF: ${robotName}`, "ok");
            const links = {}; const joints = []; const materials = {};
            
            // Robust Material Parsing
            xmlDoc.querySelectorAll('material').forEach(m => {
                const name = m.getAttribute('name'); 
                const colorNode = m.querySelector('color');
                if (name && colorNode) {
                    const rgbaStr = colorNode.getAttribute('rgba');
                    if (rgbaStr) {
                        const rgba = rgbaStr.trim().split(/\s+/).map(parseFloat);
                        if (rgba.length >= 3) {
                            materials[name] = new THREE.MeshStandardMaterial({ 
                                color: new THREE.Color(rgba[0], rgba[1], rgba[2]), 
                                roughness: 0.5, 
                                metalness: 0.5,
                                opacity: rgba.length > 3 ? rgba[3] : 1.0,
                                transparent: rgba.length > 3 && rgba[3] < 1.0
                            });
                        }
                    }
                }
            });

            xmlDoc.querySelectorAll('link').forEach(l => {
                const name = l.getAttribute('name'); 
                links[name] = { 
                    name, 
                    visual: l.querySelector('visual'), 
                    geometry: l.querySelector('visual')?.querySelector('geometry'), 
                    origin: l.querySelector('visual')?.querySelector('origin') 
                };
            });
            
            xmlDoc.querySelectorAll('joint').forEach(j => {
                const limit = j.querySelector('limit');
                const lower = limit ? parseFloat(limit.getAttribute('lower')) : -Math.PI;
                const upper = limit ? parseFloat(limit.getAttribute('upper')) : Math.PI;
                joints.push({ 
                    name: j.getAttribute('name'), 
                    type: j.getAttribute('type'), 
                    parent: j.querySelector('parent').getAttribute('link'), 
                    child: j.querySelector('child').getAttribute('link'), 
                    origin: j.querySelector('origin'), 
                    axis: j.querySelector('axis'),
                    limits: { lower, upper }
                });
            });
            this.buildScene(links, joints, materials);
        } catch (e) { console.error(e); UI.notify("URDF Parse Error", "err"); }
    },
    buildScene: function(links, joints, materials) {
        View.ready = false;
        Robot.mode = 'urdf'; Robot.joints = []; Robot.urdfJoints = []; Robot.urdfChain = [];
        document.getElementById('dh-section').style.display = 'none';
        
        // ENABLE IK UI
        // document.getElementById('ik-controls').style.opacity = '1'; // Removed: Managed by tool switch now
        // document.getElementById('ik-controls').style.pointerEvents = 'auto';
        document.getElementById('urdf-ik-warning').style.display = 'none';
        
        // Clear existing
        View.scene.remove(...View.meshes.parts.map(p => p.mesh)); 
        View.meshes.frames.forEach(f => View.scene.remove(f));
        View.meshes.parts = []; View.meshes.frames = []; // Reset arrays
        
        if (View.meshes.gripper) View.scene.remove(View.meshes.gripper); 
        if (Robot.urdfRoot) View.scene.remove(Robot.urdfRoot);
        
        const childLinks = new Set(joints.map(j => j.child)); const rootLinkName = Object.keys(links).find(l => !childLinks.has(l));
        if (!rootLinkName) return UI.notify("Invalid URDF: No root link", "err");
        
        Robot.urdfRoot = new THREE.Group(); 
        Robot.urdfRoot.rotation.x = -Math.PI / 2;
        View.scene.add(Robot.urdfRoot);

        const buildNode = (linkName, parentObj) => {
            const linkData = links[linkName]; const linkObj = new THREE.Group();
            
            // Add Frame at Link Origin
            const axis = new THREE.AxesHelper(0.15); 
            axis.visible = View.showFrames;
            linkObj.add(axis);
            View.meshes.frames.push(axis);

            if (linkData.visual && linkData.geometry) {
                const mesh = this.createVisual(linkData.geometry, linkData.visual, materials);
                if (linkData.origin) {
                    const xyzStr = linkData.origin.getAttribute('xyz');
                    const rpyStr = linkData.origin.getAttribute('rpy');
                    const xyz = xyzStr ? xyzStr.trim().split(/\s+/).map(parseFloat) : [0,0,0];
                    const rpy = rpyStr ? rpyStr.trim().split(/\s+/).map(parseFloat) : [0,0,0];
                    mesh.position.set(xyz[0], xyz[1], xyz[2]); 
                    mesh.rotation.set(rpy[0], rpy[1], rpy[2]);
                }
                linkObj.add(mesh);
                // Track for collision
                View.meshes.parts.push({ type: 'link', mesh: mesh });
            }
            parentObj.add(linkObj);
            
            const childJoints = joints.filter(j => j.parent === linkName);
            childJoints.forEach(j => {
                const jointObj = new THREE.Group();
                if (j.origin) {
                    const xyzStr = j.origin.getAttribute('xyz');
                    const rpyStr = j.origin.getAttribute('rpy');
                    const xyz = xyzStr ? xyzStr.trim().split(/\s+/).map(parseFloat) : [0,0,0];
                    const rpy = rpyStr ? rpyStr.trim().split(/\s+/).map(parseFloat) : [0,0,0];
                    jointObj.position.set(xyz[0], xyz[1], xyz[2]); 
                    jointObj.rotation.set(rpy[0], rpy[1], rpy[2]);
                }
                linkObj.add(jointObj);
                
                if (j.type !== 'fixed') {
                    const axisStr = j.axis ? j.axis.getAttribute('xyz') : '1 0 0';
                    const axisData = axisStr.trim().split(/\s+/).map(parseFloat);
                    Robot.joints.push(0);
                    // Convert limits to degrees for internal logic
                    const limitsDeg = { lower: j.limits.lower * RAD2DEG, upper: j.limits.upper * RAD2DEG };
                    Robot.urdfJoints.push({ 
                        obj: jointObj, 
                        type: j.type, 
                        axis: new THREE.Vector3(axisData[0], axisData[1], axisData[2]), 
                        name: j.name,
                        limits: limitsDeg 
                    });
                }
                buildNode(j.child, jointObj);
            });
        };
        buildNode(rootLinkName, Robot.urdfRoot);
        
        // Extract Kinematic Chain for IK
        this.createKinematicChain();

        // Update sliders with actual limits
        Robot.targetJoints = new Array(Robot.joints.length).fill(0);
        const div = document.getElementById('joint-sliders'); div.innerHTML = '';
        Robot.urdfJoints.forEach((j, i) => {
            const row = document.createElement('div'); row.className = 'input-group';
            const min = (j.limits.lower !== 0 || j.limits.upper !== 0) ? j.limits.lower : -180;
            const max = (j.limits.lower !== 0 || j.limits.upper !== 0) ? j.limits.upper : 180;
            row.innerHTML = `<div class="row"><label title="${j.name}">J${i+1}</label><span style="font-size:10px; color:#ff9100" id="val-j${i}">0¬∞</span></div><input type="range" min="${min}" max="${max}" value="0" oninput="Robot.setJoint(${i}, this.value)">`;
            div.appendChild(row);
        });

        UI.notify("URDF Imported Successfully", "ok");
        View.ready = true;
    },
    createKinematicChain: function() {
        if(Robot.urdfJoints.length === 0) return;
        const jointMap = new Map();
        Robot.urdfJoints.forEach((j, i) => jointMap.set(j.obj.uuid, i));
        const chain = [];
        let currentObj = Robot.urdfJoints[Robot.urdfJoints.length - 1].obj; 
        while(currentObj && currentObj !== Robot.urdfRoot) {
            if(jointMap.has(currentObj.uuid)) {
                const index = jointMap.get(currentObj.uuid);
                const jointData = Robot.urdfJoints[index];
                chain.unshift({ index: index, axis: jointData.axis, obj: currentObj });
            }
            currentObj = currentObj.parent;
        }
        Robot.urdfChain = chain;
    },
    createVisual: function(geomNode, visualNode, materials) {
        let geometry; const box = geomNode.querySelector('box'); const cyl = geomNode.querySelector('cylinder'); const sph = geomNode.querySelector('sphere');
        if (box) { 
            const size = box.getAttribute('size').trim().split(/\s+/).map(parseFloat); 
            geometry = new THREE.BoxGeometry(size[0], size[1], size[2]); 
        }
        else if (cyl) { 
            const r = parseFloat(cyl.getAttribute('radius')); 
            const l = parseFloat(cyl.getAttribute('length')); 
            geometry = new THREE.CylinderGeometry(r, r, l, 32); 
            geometry.rotateX(Math.PI/2); 
        }
        else if (sph) { 
            geometry = new THREE.SphereGeometry(parseFloat(sph.getAttribute('radius')), 32, 32); 
        }
        else { geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1); }
        
        let material = View.materials.link; 
        const matNode = visualNode.querySelector('material');
        if (matNode) {
            const name = matNode.getAttribute('name');
            if (name && materials[name]) {
                material = materials[name];
            } else {
                const col = matNode.querySelector('color');
                if(col) { 
                    const rgbaStr = col.getAttribute('rgba');
                    if (rgbaStr) {
                        const rgba = rgbaStr.trim().split(/\s+/).map(parseFloat); 
                        if(rgba.length >= 3) {
                            material = new THREE.MeshStandardMaterial({
                                color: new THREE.Color(rgba[0], rgba[1], rgba[2]),
                                roughness: 0.5,
                                metalness: 0.5,
                                opacity: rgba.length > 3 ? rgba[3] : 1.0,
                                transparent: rgba.length > 3 && rgba[3] < 1.0
                            });
                        }
                    }
                }
            }
        }
        const mesh = new THREE.Mesh(geometry, material);
        mesh.userData.originalMaterial = material;
        return mesh;
    }
};

const Robot = {
    dh: [], joints: [], targetJoints: [], gripper: 0, mode: 'dh', urdfJoints: [], urdfRoot: null, urdfChain: [],
    init: function(presetName) {
        this.mode = 'dh'; this.dh = JSON.parse(JSON.stringify(PRESETS[presetName]));
        this.joints = new Array(this.dh.length).fill(0); this.targetJoints = new Array(this.dh.length).fill(0);
        document.getElementById('dh-section').style.display = 'block'; 
        // document.getElementById('ik-controls').style.opacity = '1'; // Removed: Managed by tool switch now
        // document.getElementById('ik-controls').style.pointerEvents = 'auto';
        document.getElementById('urdf-ik-warning').style.display = 'none';
        if(this.urdfRoot) View.scene.remove(this.urdfRoot);
        UI.buildDHTable(); UI.buildSliders(); View.rebuildRobotModel();
    },
    dhMatrix: function(theta, d, a, alpha) {
        const ct = Math.cos(theta), st = Math.sin(theta); const ca = Math.cos(alpha), sa = Math.sin(alpha);
        return new THREE.Matrix4().set(ct, -st*ca, st*sa, a*ct, st, ct*ca, -ct*sa, a*st, 0, sa, ca, d, 0, 0, 0, 1);
    },
    forwardKinematics: function(joints) {
        if (this.mode === 'urdf') return [];
        const transforms = []; let T = new THREE.Matrix4().makeRotationX(-Math.PI/2);
        transforms.push({ pos: new THREE.Vector3(0,0,0), mat: T.clone() });
        for(let i=0; i<this.dh.length; i++) {
            const p = this.dh[i]; const q = joints[i]; let val = (p.type === 'r') ? (q * DEG2RAD) : q;
            let offset = (p.type === 'r') ? (p.offset * DEG2RAD) : 0; let alpha = p.alpha * DEG2RAD;
            let mat = (p.type === 'r') ? this.dhMatrix(val + offset, p.d, p.a, alpha) : this.dhMatrix(offset, p.d + val, p.a, alpha);
            T.multiply(mat); transforms.push({ pos: new THREE.Vector3().setFromMatrixPosition(T), mat: T.clone() });
        }
        return transforms;
    },
    solveIK: function(targetPos) {
        if (this.mode === 'urdf') return this.solveIK_URDF(targetPos);
        
        let q = [...this.targetJoints]; const lr = 0.5; const maxIter = 50;
        for(let k=0; k<maxIter; k++) {
            const chain = this.forwardKinematics(q); const tcp = chain[chain.length-1].pos;
            const err = new THREE.Vector3().subVectors(targetPos, tcp);
            if(err.length() < 0.01) break;
            for(let i=0; i<this.dh.length; i++) {
                const p = this.dh[i]; const pivot = chain[i].pos;
                const zAxis = new THREE.Vector3(0,0,1).applyMatrix4(chain[i].mat).sub(new THREE.Vector3(0,0,0).applyMatrix4(chain[i].mat)).normalize();
                let grad = (p.type === 'r') ? new THREE.Vector3().crossVectors(zAxis, new THREE.Vector3().subVectors(tcp, pivot)).dot(err) : zAxis.dot(err);
                q[i] += grad * lr;
            }
        }
        this.targetJoints = q.map(v => { while(v > 180) v-=360; while(v < -180) v+=360; return v; });
        UI.updateSliders(); Serial.sendThrottled(this.targetJoints);
        return this.targetJoints;
    },
    solveIK_URDF: function(targetPos) {
        if(this.urdfChain.length === 0) return;
        
        const iterations = 30; // Number of IK steps per frame
        const learningRate = 8.0; 
        const tolerance = 0.01;
        
        const tempPos = new THREE.Vector3();
        const axisWorld = new THREE.Vector3();
        const pivotWorld = new THREE.Vector3();
        const error = new THREE.Vector3();
        
        for (let k = 0; k < iterations; k++) {
            const lastJointObj = this.urdfJoints[this.urdfJoints.length - 1].obj;
            lastJointObj.getWorldPosition(tempPos);
            
            error.subVectors(targetPos, tempPos);
            if (error.length() < tolerance) break;
            
            for (let i = this.urdfChain.length - 1; i >= 0; i--) {
                const node = this.urdfChain[i];
                const jointIdx = node.index;
                const jointObj = node.obj;
                
                jointObj.getWorldPosition(pivotWorld);
                axisWorld.copy(node.axis).transformDirection(jointObj.matrixWorld);
                
                const r = new THREE.Vector3().subVectors(tempPos, pivotWorld);
                const cross = new THREE.Vector3().crossVectors(axisWorld, r);
                
                let delta = cross.dot(error) * learningRate;
                this.targetJoints[jointIdx] += delta;
                
                const lim = this.urdfJoints[jointIdx].limits;
                const min = (lim.lower !== 0 || lim.upper !== 0) ? lim.lower : -180;
                const max = (lim.lower !== 0 || lim.upper !== 0) ? lim.upper : 180;
                this.targetJoints[jointIdx] = clamp(this.targetJoints[jointIdx], min, max);
            }
            
            this.urdfJoints.forEach((j, idx) => {
                j.obj.quaternion.setFromAxisAngle(j.axis, this.targetJoints[idx] * DEG2RAD);
            });
            Robot.urdfRoot.updateMatrixWorld(true);
        }
        
        this.joints = [...this.targetJoints];
        UI.updateSliders();
        Serial.sendThrottled(this.targetJoints);
        return this.targetJoints;
    },
    liveIK: function() {
        const x = parseFloat(document.getElementById('ik-x').value) || 0; 
        const y = parseFloat(document.getElementById('ik-y').value) || 0; 
        const z = parseFloat(document.getElementById('ik-z').value) || 0;
        const target = new THREE.Vector3(x,y,z);
        View.updateGhost(target); 
        this.solveIK(target);
    },
    jogInterval: null,
    startJog: function(axis, amount) {
        if (this.jogInterval) return;
        this.jogInterval = setInterval(() => {
            const el = document.getElementById(`ik-${axis}`); el.value = (parseFloat(el.value) + amount).toFixed(2); this.liveIK();
        }, 50);
    },
    stopJog: function() { clearInterval(this.jogInterval); this.jogInterval = null; },
    setGripper: function(val) { this.gripper = parseFloat(val); Serial.sendThrottled(this.targetJoints); },
    setJoint: function(idx, val) { this.targetJoints[idx] = parseFloat(val); if(document.getElementById(`val-j${idx}`)) document.getElementById(`val-j${idx}`).innerText = this.targetJoints[idx].toFixed(1) + '¬∞'; Serial.sendThrottled(this.targetJoints); },
    addLink: function() {
        if (this.mode === 'urdf') return;
        this.dh.push({type:'r', d:0.2, a:0.2, alpha:0, offset:0, min:-180, max:180}); this.joints.push(0); this.targetJoints.push(0);
        UI.buildDHTable(); UI.buildSliders(); View.rebuildRobotModel(); UI.notify("Link Added", "ok");
    },
    removeLink: function() {
        if (this.mode === 'urdf' || this.dh.length <= 2) return;
        this.dh.pop(); this.joints.pop(); this.targetJoints.pop();
        UI.buildDHTable(); UI.buildSliders(); View.rebuildRobotModel(); UI.notify("Link Removed", "warn");
    },
    rebuild: function() { if (this.mode !== 'urdf') View.rebuildRobotModel(); UI.notify("Kinematics Updated", "ok"); }
};

const View = {
    scene: null, camera: null, renderer: null, controls: null, ready: false,
    meshes: { parts: [], gripper: null, ghost: null, trail: null, frames: [], fingers: [] },
    env: { floor: null, grid: null, lights: {} },
    showFrames: false, recordingTrail: true,
    init: function() {
        const el = document.getElementById('viewport'); this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(45, el.clientWidth/el.clientHeight, 0.1, 100); this.camera.position.set(3, 2.5, 3);
        this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); this.renderer.setSize(el.clientWidth, el.clientHeight);
        this.renderer.shadowMap.enabled = true; el.appendChild(this.renderer.domElement);
        this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement); this.controls.enableDamping = true;
        this.buildEnvironment(); this.buildMaterials();
        window.addEventListener('resize', () => this.onResize()); this.animate();
    },
    materials: {},
    buildMaterials: function() {
        this.materials.body = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.2, metalness: 0.8 });
        this.materials.joint = new THREE.MeshStandardMaterial({ color: 0xff9100, roughness: 0.4, metalness: 0.5, emissive: 0xff4400, emissiveIntensity: 0.1 });
        this.materials.link = new THREE.MeshStandardMaterial({ color: 0x444444, roughness: 0.7, metalness: 0.2 });
        this.materials.ghost = new THREE.MeshBasicMaterial({ color: 0xff9100, wireframe: true, transparent: true, opacity: 0.2 });
        this.materials.collision = new THREE.MeshStandardMaterial({ color: 0xff1744, roughness: 0.4, metalness: 0.3, emissive: 0xff0000, emissiveIntensity: 0.4 });
    },
    buildEnvironment: function() {
        this.env.grid = new THREE.GridHelper(20, 20, 0x333333, 0x111111);
        this.scene.add(this.env.grid);
        this.env.floor = new THREE.Mesh(new THREE.PlaneGeometry(50, 50), new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 0.1, metalness: 0.5 }));
        this.env.floor.rotation.x = -Math.PI/2; this.env.floor.position.y = -0.01; this.env.floor.receiveShadow = true; this.scene.add(this.env.floor);
        
        this.env.lights.ambient = new THREE.AmbientLight(0xffffff, 0.4);
        this.scene.add(this.env.lights.ambient);
        
        this.env.lights.spot = new THREE.SpotLight(0xff9100, 2); 
        this.env.lights.spot.position.set(5, 8, 5); this.env.lights.spot.castShadow = true; 
        this.scene.add(this.env.lights.spot);
        
        this.meshes.ghost = new THREE.Mesh(new THREE.SphereGeometry(0.05, 16, 16), this.materials.ghost); this.scene.add(this.meshes.ghost);
        const trailGeo = new THREE.BufferGeometry(); trailGeo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(5000 * 3), 3));
        this.meshes.trail = new THREE.Line(trailGeo, new THREE.LineBasicMaterial({ color: 0xff9100, transparent: true, opacity: 0.5 }));
        this.meshes.trail.frustumCulled = false; this.meshes.trail.geometry.setDrawRange(0, 0); this.scene.add(this.meshes.trail);
    },
    updateTheme: function(theme) {
        if(theme === 'light') {
            if(this.env.grid) this.env.grid.material.color.set(0xcccccc);
            if(this.env.floor) this.env.floor.material.color.set(0xf0f0f0);
            if(this.env.lights.spot) {
                this.env.lights.spot.intensity = 1.2;
                this.env.lights.spot.color.set(0xffeedd);
            }
            if(this.env.lights.ambient) this.env.lights.ambient.intensity = 0.8;
        } else {
            // Dark Default
            if(this.env.grid) this.env.grid.material.color.set(0x333333);
            if(this.env.floor) this.env.floor.material.color.set(0x050505);
            if(this.env.lights.spot) {
                this.env.lights.spot.intensity = 2;
                this.env.lights.spot.color.set(0xff9100);
            }
            if(this.env.lights.ambient) this.env.lights.ambient.intensity = 0.4;
        }
    },
    rebuildRobotModel: function() {
        this.ready = false;
        if (this.meshes.parts) this.meshes.parts.forEach(part => this.scene.remove(part.mesh));
        if (this.meshes.frames) this.meshes.frames.forEach(f => this.scene.remove(f));
        if (this.meshes.gripper) this.scene.remove(this.meshes.gripper);
        this.meshes.parts = []; this.meshes.frames = [];
        const baseFrame = new THREE.AxesHelper(0.15); baseFrame.visible = this.showFrames; this.scene.add(baseFrame); this.meshes.frames.push(baseFrame);
        for(let i=0; i<Robot.dh.length; i++) {
            const hub = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.15, 32), this.materials.joint);
            hub.geometry.rotateX(Math.PI/2); hub.castShadow = true; this.scene.add(hub); this.meshes.parts.push({ type:'joint', mesh:hub });
            const arm = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.08, 1), this.materials.link);
            arm.geometry.translate(0, 0, 0.5); arm.castShadow = true; this.scene.add(arm); this.meshes.parts.push({ type:'link', mesh:arm });
            const axis = new THREE.AxesHelper(0.15); axis.visible = this.showFrames; this.scene.add(axis); this.meshes.frames.push(axis);
        }
        const gripGroup = new THREE.Group(); gripGroup.add(new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.2, 0.05), this.materials.body));
        const f1 = new THREE.Mesh(new THREE.BoxGeometry(0.02, 0.12, 0.02), this.materials.joint); f1.position.set(0.04, 0.1, 0); gripGroup.add(f1);
        const f2 = new THREE.Mesh(new THREE.BoxGeometry(0.02, 0.12, 0.02), this.materials.joint); f2.position.set(-0.04, 0.1, 0); gripGroup.add(f2);
        this.scene.add(gripGroup); this.meshes.gripper = gripGroup; this.meshes.fingers = [f1, f2];
        this.ready = true;
    },
    updateGhost: function(pos) { if(this.meshes.ghost) this.meshes.ghost.position.copy(pos); },
    updateColor: function(type, hex) { if(this.materials[type]) this.materials[type].color.set(hex); },
    toggleFrames: function() { this.showFrames = !this.showFrames; this.meshes.frames.forEach(f => f.visible = this.showFrames); },
    toggleTrailRecord: function() { this.recordingTrail = !this.recordingTrail; },
    clearTrail: function() { this.trailCount = 0; this.meshes.trail.geometry.setDrawRange(0, 0); },
    trailCount: 0,
    updateVisuals: function(chain) {
        if (!this.ready) return;

        if (Robot.mode === 'urdf') {
            Robot.urdfJoints.forEach((j, i) => { if(j.obj) j.obj.quaternion.setFromAxisAngle(j.axis, Robot.joints[i] * DEG2RAD); });
            
            // Calculate TCP for URDF (Approximate using last joint position)
            let tcpPos = new THREE.Vector3();
            if (Robot.urdfJoints.length > 0) {
                const lastJoint = Robot.urdfJoints[Robot.urdfJoints.length-1].obj;
                lastJoint.getWorldPosition(tcpPos);
                document.getElementById('hud-tcp').innerText = `${tcpPos.x.toFixed(2)}, ${tcpPos.y.toFixed(2)}, ${tcpPos.z.toFixed(2)}`;
            }

            // Update Trail
            if(this.recordingTrail && this.trailCount < 5000) {
                const positions = this.meshes.trail.geometry.attributes.position.array;
                let lastPos = new THREE.Vector3(positions[(this.trailCount-1)*3], positions[(this.trailCount-1)*3+1], positions[(this.trailCount-1)*3+2]);
                
                if (this.trailCount === 0 || tcpPos.distanceTo(lastPos) > 0.01) {
                    positions[this.trailCount*3] = tcpPos.x; 
                    positions[this.trailCount*3+1] = tcpPos.y; 
                    positions[this.trailCount*3+2] = tcpPos.z;
                    this.trailCount++; 
                    this.meshes.trail.geometry.attributes.position.needsUpdate = true; 
                    this.meshes.trail.geometry.setDrawRange(0, this.trailCount);
                }
            }

            Plotter.push(tcpPos.x, tcpPos.y, tcpPos.z);
            this.checkCollisions();
            return;
        }

        if (!chain || chain.length === 0) return;

        if (this.meshes.frames && this.meshes.frames[0]) {
            this.meshes.frames[0].position.copy(chain[0].pos); this.meshes.frames[0].quaternion.setFromRotationMatrix(chain[0].mat);
        }

        for(let i=0; i<Robot.dh.length; i++) {
            const start = chain[i].pos; const end = chain[i+1].pos;
            if (this.meshes.parts[i*2]) {
                const hub = this.meshes.parts[i*2].mesh; hub.position.copy(start); hub.quaternion.setFromRotationMatrix(chain[i].mat);
            }
            if (this.meshes.parts[i*2+1]) {
                const arm = this.meshes.parts[i*2+1].mesh; const dist = start.distanceTo(end);
                if(dist > 0.001) { arm.visible = true; arm.position.copy(start); arm.lookAt(end); arm.scale.set(1, 1, dist); } else arm.visible = false;
            }
            if (this.meshes.frames && this.meshes.frames[i+1]) {
                this.meshes.frames[i+1].position.copy(chain[i+1].pos); this.meshes.frames[i+1].quaternion.setFromRotationMatrix(chain[i+1].mat);
            }
        }
        const tcpFrame = chain[chain.length-1];
        if(this.meshes.gripper) {
            this.meshes.gripper.position.copy(tcpFrame.pos); this.meshes.gripper.quaternion.setFromRotationMatrix(tcpFrame.mat);
            this.meshes.fingers[0].position.x = 0.04 + (Robot.gripper * 0.02); this.meshes.fingers[1].position.x = -(0.04 + (Robot.gripper * 0.02));
        }
        if(this.recordingTrail && this.trailCount < 5000) {
            const positions = this.meshes.trail.geometry.attributes.position.array;
            if (this.trailCount === 0 || tcpFrame.pos.distanceTo(new THREE.Vector3(positions[(this.trailCount-1)*3], positions[(this.trailCount-1)*3+1], positions[(this.trailCount-1)*3+2])) > 0.01) {
                positions[this.trailCount*3] = tcpFrame.pos.x; positions[this.trailCount*3+1] = tcpFrame.pos.y; positions[this.trailCount*3+2] = tcpFrame.pos.z;
                this.trailCount++; this.meshes.trail.geometry.attributes.position.needsUpdate = true; this.meshes.trail.geometry.setDrawRange(0, this.trailCount);
            }
        }
        Plotter.push(tcpFrame.pos.x, tcpFrame.pos.y, tcpFrame.pos.z);
        document.getElementById('hud-tcp').innerText = `${tcpFrame.pos.x.toFixed(2)}, ${tcpFrame.pos.y.toFixed(2)}, ${tcpFrame.pos.z.toFixed(2)}`;
        this.checkCollisions();
    },
    checkCollisions: function() {
        if (!this.ready) return;
        
        // Reset to original material logic
        // For URDF, we use the stored original material. For DH, we use the global materials.
        this.meshes.parts.forEach(p => { 
            if(p.mesh) {
                if (Robot.mode === 'urdf' && p.mesh.userData.originalMaterial) {
                    p.mesh.material = p.mesh.userData.originalMaterial;
                } else {
                    p.mesh.material = (p.type === 'joint') ? this.materials.joint : this.materials.link;
                }
            }
        });
        
        if(this.meshes.gripper) this.meshes.gripper.children.forEach(c => c.material = this.materials.body);
        let collisionDetected = false;
        const boxes = this.meshes.parts.map(p => new THREE.Box3().setFromObject(p.mesh).expandByScalar(-0.015));
        this.meshes.parts.forEach((p, i) => { if (i > 0 && boxes[i] && boxes[i].min.y < 0) { p.mesh.material = this.materials.collision; collisionDetected = true; } });
        for(let i=0; i<this.meshes.parts.length; i++) {
            for(let j=i+1; j<this.meshes.parts.length; j++) {
                if (Math.abs(Math.floor(i/2) - Math.floor(j/2)) <= 1) continue;
                if (boxes[i] && boxes[j] && boxes[i].intersectsBox(boxes[j])) { 
                    this.meshes.parts[i].mesh.material = this.materials.collision; 
                    this.meshes.parts[j].mesh.material = this.materials.collision; 
                    collisionDetected = true; 
                }
            }
        }
        const hudStatus = document.getElementById('hud-status');
        if(collisionDetected) { hudStatus.innerText = "COLLISION"; hudStatus.style.color = "var(--status-err)"; hudStatus.classList.add('collision-warn'); }
        else { hudStatus.innerText = "ONLINE"; hudStatus.style.color = "var(--status-ok)"; hudStatus.classList.remove('collision-warn'); }
    },
    animate: function() {
        requestAnimationFrame(() => this.animate());
        if (!this.ready) return;
        let maxVel = 0;
        for(let i=0; i<Robot.joints.length; i++) {
            const diff = Robot.targetJoints[i] - Robot.joints[i];
            if(Math.abs(diff) > 0.01) { const step = diff * 0.15; Robot.joints[i] += step; maxVel = Math.max(maxVel, Math.abs(step)); } else Robot.joints[i] = Robot.targetJoints[i];
        }
        this.updateVisuals(Robot.forwardKinematics(Robot.joints)); this.controls.update(); this.renderer.render(this.scene, this.camera);
        Telemetry.push(maxVel); document.getElementById('hud-vel').innerText = (maxVel * 60).toFixed(1) + " deg/s";
    },
    onResize: function() {
        const el = document.getElementById('viewport'); this.camera.aspect = el.clientWidth/el.clientHeight; this.camera.updateProjectionMatrix(); this.renderer.setSize(el.clientWidth, el.clientHeight);
    }
};

const AI = {
    generateScript: async function() {
        const prompt = document.getElementById('ai-prompt').value; if(!prompt) return UI.notify("Please enter a command", "err");
        UI.notify("Consulting Gemini...", "warn");
        const systemPrompt = `Expert industrial robot programmer. Translate natural language to "RevoScript". Syntax: MOVE x y z, GRIP 1/0, WAIT ms, HOME, SPEED val.`;
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
            });
            const data = await res.json();
            let code = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (code) {
                document.getElementById('script-area').value = "// Generated ‚ú®\n" + code.replace(/```[a-z]*\n|```/g, '').trim();
                UI.notify("Script Generated!", "ok"); UI.toggleTool('script');
            }
        } catch (e) { UI.notify("AI Request Failed", "err"); }
    }
};

const Script = {
    running: false, lines: [], pc: 0,
    run: function() { if(this.running) return; this.lines = document.getElementById('script-area').value.split('\n'); this.pc = 0; this.running = true; UI.notify("Script Started", "ok"); this.step(); },
    stop: function() { this.running = false; UI.notify("Script Stopped", "err"); },
    step: function() {
        if(!this.running || this.pc >= this.lines.length) { this.running = false; return; }
        const line = this.lines[this.pc].trim(); this.pc++;
        if(!line || line.startsWith('//')) { this.step(); return; }
        const p = line.split(/\s+/); const cmd = p[0].toUpperCase();
        switch(cmd) {
            case 'MOVE': 
                const target = new THREE.Vector3(parseFloat(p[1]), parseFloat(p[2]), parseFloat(p[3]));
                Robot.solveIK(target); 
                View.updateGhost(target); 
                setTimeout(() => this.step(), 1000); 
                break;
            case 'WAIT': setTimeout(() => this.step(), parseInt(p[1])); break;
            case 'GRIP': Robot.setGripper(parseFloat(p[1])); setTimeout(() => this.step(), 500); break;
            case 'HOME': Robot.targetJoints = new Array(Robot.dh.length).fill(0); setTimeout(() => this.step(), 1000); break;
            default: this.step();
        }
    }
};

const Env = {
    tent: null,
    toggleWorkspace: function() {
        if(this.tent) { View.scene.remove(this.tent); this.tent = null; return; }
        UI.notify("Generating Smooth Hull...", "warn");
        
        setTimeout(() => {
            const points = [];
            
            if (Robot.mode === 'urdf') {
                // URDF Hull Generation
                if (!Robot.urdfRoot || Robot.urdfJoints.length === 0) return;
                
                const originalJoints = [...Robot.joints];
                const lastJoint = Robot.urdfJoints[Robot.urdfJoints.length - 1].obj;
                const tempPos = new THREE.Vector3();

                // Sampling loop
                for (let i = 0; i < 1500; i++) {
                    Robot.urdfJoints.forEach(j => {
                        // Random angle within limits
                        const min = (j.limits.lower !== 0 || j.limits.upper !== 0) ? j.limits.lower : -180;
                        const max = (j.limits.lower !== 0 || j.limits.upper !== 0) ? j.limits.upper : 180;
                        const angle = Math.random() * (max - min) + min;
                        j.obj.quaternion.setFromAxisAngle(j.axis, angle * DEG2RAD);
                    });
                    
                    Robot.urdfRoot.updateMatrixWorld(true);
                    lastJoint.getWorldPosition(tempPos);
                    
                    // Simple ground clip
                    if (tempPos.y >= 0) points.push(tempPos.clone());
                }

                // Restore original state
                Robot.joints = originalJoints;
                View.updateVisuals([]); // Trigger URDF update
            } else {
                // DH Hull Generation
                for(let i=0; i<3000; i++) { 
                    const q = Robot.dh.map(p => Math.random()*(p.max-p.min) + p.min); 
                    const c = Robot.forwardKinematics(q); 
                    const pos = c[c.length-1].pos; 
                    if(pos.y >= 0) points.push(pos); 
                }
            }

            if(points.length > 4) { 
                this.tent = new THREE.Mesh(new THREE.ConvexGeometry(points), new THREE.MeshPhongMaterial({ color: 0xff9100, transparent: true, opacity: 0.15, side: THREE.DoubleSide, shininess: 90 })); 
                View.scene.add(this.tent); 
                UI.notify("Workspace Generated", "ok"); 
            } else {
                UI.notify("Workspace Gen Failed", "err");
            }
        }, 50);
    }
};

const UI = {
    activeTool: null,
    toggleTool: function(id) {
        const panel = document.getElementById('tools-panel-container');
        const btns = document.querySelectorAll('.tool-btn');
        
        // Toggle Logic
        if (this.activeTool === id) {
            // Close if clicking same tool
            this.closePanel();
            return;
        }
        
        // Open/Switch
        this.activeTool = id;
        panel.classList.remove('collapsed');
        
        // Update Buttons
        btns.forEach(b => {
            b.classList.toggle('active', b.id === `btn-${id}`);
        });
        
        // Update Panels
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(`panel-${id}`).classList.add('active');
        
        // Update Title
        const titleMap = {
            'setup': 'Robot Architecture',
            'env': 'Environment & View',
            'ik': 'Inverse Kinematics',
            'joints': 'Joint & Gripper Control',
            'connect': 'Hardware Connection',
            'export': 'Code Export',
            'script': 'AI Scripting',
            'ros': 'ROS Integration'
        };
        const iconMap = {
            'setup': 'wrench',
            'env': 'globe',
            'ik': 'crosshair',
            'joints': 'sliders-horizontal',
            'connect': 'plugs',
            'export': 'file-code',
            'script': 'magic-wand',
            'ros': 'infinity'
        };
        document.getElementById('active-panel-title').innerHTML = `<i class="ph ph-${iconMap[id]}"></i> ${titleMap[id]}`;

        if(id === 'export') CodeGen.generate();
    },
    closePanel: function() {
        document.getElementById('tools-panel-container').classList.add('collapsed');
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        this.activeTool = null;
    },
    setTheme: function(theme) {
        if(theme === 'light') {
            document.body.classList.add('light-theme');
        } else {
            document.body.classList.remove('light-theme');
        }
        View.updateTheme(theme);
        UI.notify(`Theme set to ${theme.toUpperCase()}`, "ok");
    },
    buildDHTable: function() {
        const tbody = document.querySelector('#dh-table tbody'); tbody.innerHTML = '';
        Robot.dh.forEach((p, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${p.type.toUpperCase()}</td><td><input type="number" value="${p.d}" onchange="Robot.dh[${i}].d=parseFloat(this.value); View.rebuildRobotModel()"></td><td><input type="number" value="${p.a}" onchange="Robot.dh[${i}].a=parseFloat(this.value); View.rebuildRobotModel()"></td><td><input type="number" value="${p.alpha}" onchange="Robot.dh[${i}].alpha=parseFloat(this.value); View.rebuildRobotModel()"></td><td><input type="number" value="${p.offset}" onchange="Robot.dh[${i}].offset=parseFloat(this.value)"></td>`;
            tbody.appendChild(tr);
        });
    },
    buildSliders: function() {
        const div = document.getElementById('joint-sliders'); div.innerHTML = '';
        Robot.dh.forEach((p, i) => {
            const row = document.createElement('div'); row.className = 'input-group';
            row.innerHTML = `<div class="row"><label>J${i+1}</label><span style="font-size:10px; color:#ff9100" id="val-j${i}">0¬∞</span></div><input type="range" min="${p.min}" max="${p.max}" value="0" oninput="Robot.setJoint(${i}, this.value)">`;
            div.appendChild(row);
        });
    },
    updateSliders: function() {
        Robot.targetJoints.forEach((v, i) => { 
            const el = document.querySelector(`#joint-sliders input:nth-of-type(${i+1})`); 
            if(el) { el.value = v; if(document.getElementById(`val-j${i}`)) document.getElementById(`val-j${i}`).innerText = v.toFixed(1) + '¬∞'; }
        });
    },
    notify: function(msg, type) {
        const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg;
        if(type==='err') t.style.borderColor = '#ff1744'; else if(type==='ok') t.style.borderColor = '#00e676';
        document.getElementById('toast-area').appendChild(t); setTimeout(() => t.remove(), 3000);
    }
};

const CodeGen = {
    generate: function() {
        const lang = document.getElementById('code-lang').value;
        document.getElementById('export-area').value = lang === 'cpp' ? this.cpp() : this.py();
    },
    copy: function() { document.getElementById('export-area').select(); document.execCommand('copy'); UI.notify("Code Copied", "ok"); },
    cpp: function() {
        let code = `// RevoLab Arduino Driver\n#include <Servo.h>\nconst int SERVO_PINS[] = { ${Robot.dh.map((_, i) => i + 2).join(', ')} };\nServo joints[${Robot.dh.length}];\n\nvoid setup() {\n  Serial.begin(115200);\n  for(int i=0; i<${Robot.dh.length}; i++) joints[i].attach(SERVO_PINS[i]);\n}\n\nvoid loop() {\n  if(Serial.available()) { /* Parsing logic */ }\n}`;
        return code;
    },
    py: function() { return `import numpy as np\ndh = ` + JSON.stringify(Robot.dh) + `\ndef forward(q):\n  pass`; }
};

const Sim = { loadPreset: function(p) { Robot.init(p); }, resetCamera: function() { View.controls.reset(); }, hardReset: function() { location.reload(); } };

window.onload = function() { 
    const fill = document.getElementById('loader-fill'); const txt = document.getElementById('loader-text'); let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 2; if (progress > 100) progress = 100;
        fill.style.width = `${progress}%`; txt.innerText = `INITIALIZING... [${Math.floor(progress)}%]`;
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                document.getElementById('loader').style.opacity = 0; document.getElementById('app-container').classList.add('visible');
                View.init(); Robot.init('simple'); setTimeout(() => { if(document.getElementById('loader')) document.getElementById('loader').remove(); }, 800);
            }, 500);
        }
    }, 30);
};
</script>
</body>
</html>
```
