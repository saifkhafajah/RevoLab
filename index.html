<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RevoLab Simulator | Industrial Robotics</title>
    
    <!-- Three.js Core & Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/math/ConvexHull.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/ConvexGeometry.js"></script>

    <style>
        :root {
            --bg-app: #0a0a0a;
            --bg-panel: #141414;
            --bg-input: #1f1f1f;
            --border-color: #333333;
            --accent-primary: #ff9100;
            --accent-hover: #ffb74d;
            --accent-dim: rgba(255, 145, 0, 0.15);
            --text-main: #e0e0e0;
            --text-muted: #757575;
            --text-highlight: #ffffff;
            --status-ok: #00e676;
            --status-warn: #ffea00;
            --status-err: #ff1744;
            --font-ui: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
        }

        * { box-sizing: border-box; user-select: none; }

        body { margin: 0; background-color: var(--bg-app); color: var(--text-main); font-family: var(--font-ui); overflow: hidden; height: 100vh; display: flex; }

        #app-container { display: flex; width: 100%; height: 100%; }
        #sidebar { width: 420px; min-width: 420px; background-color: var(--bg-panel); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 10; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        #viewport { flex-grow: 1; position: relative; background: radial-gradient(circle at center, #1a1a1a 0%, #000000 120%); overflow: hidden; }

        /* Components */
        .header { padding: 20px; border-bottom: 1px solid var(--border-color); background: linear-gradient(180deg, #1a1a1a 0%, var(--bg-panel) 100%); }
        .header h1 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 2px; color: var(--accent-primary); text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .header h1::before { content: ''; display: block; width: 12px; height: 12px; background: var(--accent-primary); box-shadow: 0 0 10px var(--accent-primary); border-radius: 50%; }
        .header h2 { margin: 5px 0 0 22px; font-size: 11px; color: var(--text-muted); letter-spacing: 1px; font-weight: 400; }

        .tabs { display: flex; background: #0f0f0f; border-bottom: 1px solid var(--border-color); }
        .tab-btn { flex: 1; padding: 15px 0; background: transparent; border: none; color: var(--text-muted); font-size: 11px; font-weight: 600; text-transform: uppercase; cursor: pointer; transition: all 0.2s ease; border-bottom: 2px solid transparent; }
        .tab-btn:hover { color: var(--text-main); background: #1a1a1a; }
        .tab-btn.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); background: var(--accent-dim); }

        .tab-content { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; }
        .panel { display: none; padding: 20px; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .panel.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .control-section { background: #181818; border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; margin-bottom: 15px; }
        .section-title { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 8px; }
        label { font-size: 12px; color: var(--text-muted); min-width: 60px; }
        
        input[type="number"], input[type="text"], select { background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); padding: 8px; border-radius: 4px; width: 100%; font-family: var(--font-mono); font-size: 12px; outline: none; transition: border-color 0.2s; }
        input:focus, select:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 1px var(--accent-dim); }
        
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: #333; border-radius: 2px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--text-main); border: 2px solid var(--bg-panel); border-radius: 50%; cursor: pointer; transition: transform 0.1s, background 0.2s; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); background: var(--accent-primary); }
        
        input[type="color"] { -webkit-appearance: none; border: none; width: 100%; height: 30px; cursor: pointer; background: transparent; padding: 0; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid var(--border-color); border-radius: 4px; }

        .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
        .btn-grid.tri { grid-template-columns: repeat(3, 1fr); }
        button { background: #252525; border: 1px solid transparent; color: var(--text-main); padding: 10px 15px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 6px; }
        button:hover { background: #333; transform: translateY(-1px); }
        button.primary { background: var(--accent-primary); color: #000; }
        button.primary:hover { background: var(--accent-hover); box-shadow: 0 4px 15px var(--accent-dim); }
        button.danger { background: rgba(255, 23, 68, 0.1); color: #ff1744; border-color: rgba(255, 23, 68, 0.3); }
        button.danger:hover { background: rgba(255, 23, 68, 0.2); }

        .editor-wrapper { position: relative; border: 1px solid var(--border-color); background: #0f0f0f; border-radius: 4px; }
        textarea.code-area { width: 100%; height: 300px; background: transparent; border: none; color: #ffb74d; font-family: var(--font-mono); font-size: 12px; padding: 10px; resize: vertical; outline: none; line-height: 1.5; }
        
        /* Plot Overlay */
        #plot-overlay { position: absolute; bottom: 20px; right: 20px; width: 300px; background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(8px); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; pointer-events: auto; box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 8px; }
        .plot-header { display: flex; justify-content: space-between; align-items: center; }
        .plot-title { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .plot-controls { display: flex; gap: 4px; }
        .plot-controls button { padding: 4px 8px; font-size: 9px; min-width: auto; height: auto; }
        .plot-legend { display: flex; justify-content: space-between; font-size: 9px; font-family: var(--font-mono); color: #666; margin-top: 2px; }
        canvas#plot-canvas { width: 100%; height: 100px; background: #000; border-radius: 2px; border: 1px solid #333; display: block; }

        /* HUD */
        #hud-container { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; pointer-events: none; }
        .hud-panel { background: rgba(15, 15, 15, 0.85); backdrop-filter: blur(8px); border-left: 2px solid var(--accent-primary); padding: 10px 15px; border-radius: 0 4px 4px 0; min-width: 180px; }
        .hud-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .hud-value { font-family: var(--font-mono); font-size: 14px; color: var(--text-highlight); font-weight: 700; }
        .hud-value.accent { color: var(--accent-primary); }

        #toast-area { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 10px; pointer-events: none; z-index: 100; }
        .toast { background: #1a1a1a; color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 12px; border: 1px solid var(--border-color); box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px; opacity: 0; transform: translateY(10px); animation: popIn 0.3s forwards; }
        @keyframes popIn { to { opacity: 1; transform: translateY(0); } }

        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: center; color: var(--accent-primary); padding: 8px 4px; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        td { padding: 4px; }
        
        #ai-prompt { background: rgba(255, 145, 0, 0.05); border: 1px solid var(--accent-primary); color: #fff; font-family: var(--font-ui); margin-bottom: 8px; }
        #ai-prompt::placeholder { color: #886644; }

        .hw-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; display: inline-block; margin-right: 5px; }
        .hw-status-dot.connected { background: var(--status-ok); box-shadow: 0 0 5px var(--status-ok); }
    </style>
</head>
<body>

<div id="app-container">
    <div id="sidebar">
        <div class="header">
            <h1>RevoLab <span style="font-size:10px; opacity:0.5; font-weight:400; border:1px solid #555; padding:2px 4px; border-radius:3px;">V5.0</span></h1>
            <h2>Advanced Robotics Core</h2>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="UI.switchTab('setup')">Setup</button>
            <button class="tab-btn" onclick="UI.switchTab('control')">Control</button>
            <button class="tab-btn" onclick="UI.switchTab('script')">Script</button>
            <button class="tab-btn" onclick="UI.switchTab('code')">Export</button>
        </div>

        <!-- SETUP -->
        <div id="tab-setup" class="tab-content panel active">
            <div class="control-section">
                <div class="section-title">Robot Configuration</div>
                <div class="input-group">
                    <label style="display:block; margin-bottom:5px;">Architecture Preset</label>
                    <select id="preset-sel" onchange="Sim.loadPreset(this.value)">
                        <option value="simple" selected>Simple 3-DOF</option>
                        <option value="ur5">UR5 (Cobot)</option>
                        <option value="scara">SCARA (Pick & Place)</option>
                    </select>
                </div>
                <div class="btn-grid">
                    <button onclick="Sim.resetCamera()">Reset View</button>
                    <button class="danger" onclick="Sim.hardReset()">Hard Reset</button>
                </div>
            </div>

            <div class="control-section">
                <div class="section-title">
                    <span>Hardware Bridge (Serial)</span>
                    <div style="display:flex; align-items:center;">
                        <div id="hw-dot" class="hw-status-dot"></div>
                        <span id="hw-status-text" style="font-size:9px; color:var(--text-muted)">DISCONNECTED</span>
                    </div>
                </div>
                <div class="row">
                    <label>Baud Rate</label>
                    <select id="baud-rate" style="width: 100px;">
                        <option value="9600">9600</option>
                        <option value="57600">57600</option>
                        <option value="115200" selected>115200</option>
                    </select>
                </div>
                <div class="btn-grid">
                    <button class="primary" id="btn-hw-connect" onclick="Hardware.connect()">Connect Controller</button>
                    <button onclick="Hardware.disconnect()" id="btn-hw-disconnect" style="display:none;">Disconnect</button>
                </div>
                <div style="margin-top:10px; font-size:10px; color:var(--text-muted); line-height:1.4;">
                    Streams: <code style="color:var(--accent-primary)">q1, q2, ... qn \n</code>
                </div>
            </div>
            
            <div class="control-section">
                <div class="section-title">Appearance</div>
                <div class="row">
                    <label>Joint Color</label>
                    <input type="color" value="#ff9100" oninput="View.updateColor('joint', this.value)">
                </div>
                <div class="row">
                    <label>Link Color</label>
                    <input type="color" value="#444444" oninput="View.updateColor('link', this.value)">
                </div>
            </div>

            <div class="control-section">
                <div class="section-title">
                    <span>DH Parameters</span>
                    <span style="font-size:9px; color:#555">Modified Denavit-Hartenberg</span>
                </div>
                <table id="dh-table">
                    <thead>
                        <tr>
                            <th title="Joint Type">Type</th>
                            <th title="Link Offset">d</th>
                            <th title="Link Length">a</th>
                            <th title="Link Twist">&alpha;</th>
                            <th title="Joint Offset">Off</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="btn-grid tri" style="margin-top:10px;">
                    <button onclick="Robot.addLink()">+</button>
                    <button onclick="Robot.removeLink()">-</button>
                    <button class="primary" onclick="Robot.rebuild()">Apply</button>
                </div>
            </div>

            <div class="control-section">
                <div class="section-title">Environment</div>
                <div class="row">
                    <label>Workspace</label>
                    <button onclick="Env.toggleWorkspace()">Generate 3D Hull</button>
                </div>
                <div class="row">
                    <label>Visuals</label>
                    <button onclick="View.toggleFrames()">Toggle Joint Frames</button>
                </div>
                <div class="row">
                    <label>Assets</label>
                    <button onclick="Env.spawnCrate()">Spawn Target Crate</button>
                </div>
            </div>
        </div>

        <!-- CONTROL -->
        <div id="tab-control" class="tab-content panel">
            <div class="control-section">
                <div class="section-title">Inverse Kinematics</div>
                <div class="row">
                    <input type="number" id="ik-x" placeholder="X" value="1.0" step="0.01" oninput="Robot.liveIK()">
                    <input type="number" id="ik-y" placeholder="Y" value="1.0" step="0.01" oninput="Robot.liveIK()">
                    <input type="number" id="ik-z" placeholder="Z" value="0.5" step="0.01" oninput="Robot.liveIK()">
                </div>
                <div class="btn-grid tri" style="margin-top:10px;">
                    <button onmousedown="Robot.startJog('x', 0.05)" onmouseup="Robot.stopJog()" onmouseleave="Robot.stopJog()">X+</button>
                    <button onmousedown="Robot.startJog('y', 0.05)" onmouseup="Robot.stopJog()" onmouseleave="Robot.stopJog()">Y+</button>
                    <button onmousedown="Robot.startJog('z', 0.05)" onmouseup="Robot.stopJog()" onmouseleave="Robot.stopJog()">Z+</button>
                    <button onmousedown="Robot.startJog('x', -0.05)" onmouseup="Robot.stopJog()" onmouseleave="Robot.stopJog()">X-</button>
                    <button onmousedown="Robot.startJog('y', -0.05)" onmouseup="Robot.stopJog()" onmouseleave="Robot.stopJog()">Y-</button>
                    <button onmousedown="Robot.startJog('z', -0.05)" onmouseup="Robot.stopJog()" onmouseleave="Robot.stopJog()">Z-</button>
                </div>
            </div>

            <div class="control-section">
                <div class="section-title">Joint Override</div>
                <div id="joint-sliders"></div>
            </div>

            <div class="control-section">
                <div class="section-title">End Effector</div>
                <div class="row">
                    <label>Gripper</label>
                    <input type="range" min="0" max="1" step="0.01" value="0" oninput="Robot.setGripper(this.value)">
                </div>
            </div>
        </div>

        <!-- SCRIPT -->
        <div id="tab-script" class="tab-content panel">
            <div class="control-section" style="border-color: var(--accent-primary);">
                <div class="section-title" style="color: var(--accent-primary);">✨ Gemini Copilot</div>
                <input type="text" id="ai-prompt" placeholder="e.g., Pick up the crate and stack it at x=0">
                <button class="primary" onclick="AI.generateScript()">Generate RevoScript ✨</button>
            </div>

            <div class="control-section">
                <div class="section-title">RevoScript Editor</div>
                <div class="editor-wrapper">
                    <textarea id="script-area" class="code-area" spellcheck="false">
// Pick and Place Demo
SPEED 50
HOME
GRIP 0

// Approach
MOVE 1.0 0.5 0.5
WAIT 500

// Descent
MOVE 1.0 0.1 0.5
WAIT 500
GRIP 1
WAIT 500

// Lift
MOVE 1.0 0.8 0.5
// Move Away
MOVE 0.0 0.8 1.0
// Drop
GRIP 0
HOME</textarea>
                </div>
                <div class="btn-grid">
                    <button class="primary" onclick="Script.run()">Execute</button>
                    <button class="danger" onclick="Script.stop()">Halt</button>
                </div>
            </div>
            
            <div class="control-section">
                <div class="section-title">Telemetry</div>
                <canvas id="telemetry"></canvas>
                <div style="display:flex; justify-content:space-between; font-size:9px; color:#555; margin-top:5px;">
                    <span>T-5s</span>
                    <span>NOW</span>
                </div>
            </div>
        </div>

        <!-- CODE -->
        <div id="tab-code" class="tab-content panel">
            <div class="control-section">
                <div class="section-title">Driver Export</div>
                <div class="input-group">
                    <select id="code-lang" onchange="CodeGen.generate()">
                        <option value="cpp">C++ (Embedded/Arduino)</option>
                        <option value="python">Python (NumPy)</option>
                    </select>
                </div>
                <div class="editor-wrapper" style="margin-top: 10px;">
                    <textarea id="export-area" class="code-area" readonly></textarea>
                </div>
                <button class="primary" style="margin-top:10px; width: 100%;" onclick="CodeGen.copy()">Copy to Clipboard</button>
            </div>
        </div>

        <div style="padding: 15px; border-top: 1px solid var(--border-color); background: #0f0f0f; text-align: center; margin-top: auto;">
            <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px;">Created By</div>
            <div style="font-size: 12px; font-weight: 700; color: var(--text-main); letter-spacing: 0.5px;">Saif Khafajah</div>
        </div>
    </div>

    <!-- VIEWPORT -->
    <div id="viewport">
        <div id="hud-container">
            <div class="hud-panel">
                <div class="hud-label">System Status</div>
                <div class="hud-value" id="hud-status" style="color:var(--status-ok)">ONLINE</div>
            </div>
            <div class="hud-panel">
                <div class="hud-label">Tool Center Point (TCP)</div>
                <div class="hud-value accent" id="hud-tcp">0.00, 0.00, 0.00</div>
            </div>
            <div class="hud-panel">
                <div class="hud-label">Joint Velocity (Max)</div>
                <div class="hud-value" id="hud-vel">0.0 rad/s</div>
            </div>
        </div>

        <div id="plot-overlay">
            <div class="plot-header">
                <div class="plot-title">Live Trajectory</div>
                <div class="plot-controls">
                    <button onclick="View.toggleTrailRecord()" title="Toggle 3D Trail">Trail</button>
                    <button class="danger" onclick="View.clearTrail()" title="Clear 3D">Clr 3D</button>
                    <button class="primary" onclick="Plotter.togglePause()" title="Pause 2D">||</button>
                    <button onclick="Plotter.clear()" title="Clear 2D">Clr 2D</button>
                </div>
            </div>
            <canvas id="plot-canvas"></canvas>
            <div class="plot-legend">
                <span style="color:#ff4444">■ X-Pos</span>
                <span style="color:#44ff44">■ Y-Pos</span>
                <span style="color:#4444ff">■ Z-Pos</span>
            </div>
        </div>

        <div id="toast-area"></div>
    </div>
</div>

<script>
// --- UTILITIES ---
const RAD2DEG = 180 / Math.PI;
const DEG2RAD = Math.PI / 180;
const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
const apiKey = ""; 

// --- CONFIGURATION ---
const PRESETS = {
    ur5: [
        { type:'r', d:0.4, a:0, alpha:90, offset:0, min:-360, max:360 },
        { type:'r', d:0, a:-0.425, alpha:0, offset:-90, min:-360, max:360 },
        { type:'r', d:0, a:-0.392, alpha:0, offset:0, min:-360, max:360 },
        { type:'r', d:0.1, a:0, alpha:90, offset:90, min:-360, max:360 },
        { type:'r', d:0.1, a:0, alpha:-90, offset:0, min:-360, max:360 },
        { type:'r', d:0.1, a:0, alpha:0, offset:0, min:-360, max:360 }
    ],
    scara: [
        { type:'r', d:0.4, a:0.5, alpha:0, offset:0, min:-160, max:160 },
        { type:'r', d:0.3, a:0.4, alpha:180, offset:0, min:-150, max:150 },
        { type:'p', d:0.1, a:0, alpha:0, offset:0, min:0, max:0.3 },
        { type:'r', d:0.1, a:0, alpha:0, offset:0, min:-360, max:360 }
    ],
    simple: [
        { type:'r', d:0.5, a:0, alpha:90, offset:0, min:-180, max:180 },
        { type:'r', d:0, a:0.5, alpha:0, offset:0, min:-180, max:180 },
        { type:'r', d:0, a:0.5, alpha:0, offset:0, min:-180, max:180 }
    ]
};

const Robot = {
    dh: [], joints: [], targetJoints: [], gripper: 0, holdingObject: null,
    
    init: function(presetName) {
        this.dh = JSON.parse(JSON.stringify(PRESETS[presetName]));
        this.joints = new Array(this.dh.length).fill(0);
        this.targetJoints = new Array(this.dh.length).fill(0);
        UI.buildDHTable();
        UI.buildSliders();
        View.rebuildRobotModel();
    },

    dhMatrix: function(theta, d, a, alpha) {
        const ct = Math.cos(theta), st = Math.sin(theta);
        const ca = Math.cos(alpha), sa = Math.sin(alpha);
        return new THREE.Matrix4().set(
            ct, -st*ca, st*sa, a*ct,
            st, ct*ca, -ct*sa, a*st,
            0, sa, ca, d,
            0, 0, 0, 1
        );
    },

    forwardKinematics: function(joints) {
        const transforms = [];
        let T = new THREE.Matrix4().makeRotationX(-Math.PI/2);
        transforms.push({ pos: new THREE.Vector3(0,0,0), mat: T.clone() });

        for(let i=0; i<this.dh.length; i++) {
            const p = this.dh[i];
            const q = joints[i];
            let val = (p.type === 'r') ? (q * DEG2RAD) : q;
            let offset = (p.offset * DEG2RAD);
            let alpha = p.alpha * DEG2RAD;
            let mat;
            if(p.type === 'r') mat = this.dhMatrix(val + offset, p.d, p.a, alpha);
            else mat = this.dhMatrix(offset, p.d + val, p.a, alpha);
            T.multiply(mat);
            transforms.push({ pos: new THREE.Vector3().setFromMatrixPosition(T), mat: T.clone() });
        }
        return transforms;
    },

    solveIK: function(targetPos) {
        let q = [...this.targetJoints];
        const lr = 0.5; const maxIter = 100;
        for(let k=0; k<maxIter; k++) {
            const chain = this.forwardKinematics(q);
            const tcp = chain[chain.length-1].pos;
            const err = new THREE.Vector3().subVectors(targetPos, tcp);
            if(err.length() < 0.005) break;
            
            for(let i=0; i<this.dh.length; i++) {
                const p = this.dh[i];
                const frame = chain[i];
                const pivot = chain[i].pos;
                const zAxis = new THREE.Vector3(0,0,1).applyMatrix4(frame.mat).sub(new THREE.Vector3().setFromMatrixPosition(frame.mat)).normalize();
                
                let grad = 0;
                if(p.type === 'r') {
                    const r = new THREE.Vector3().subVectors(tcp, pivot);
                    const cross = new THREE.Vector3().crossVectors(zAxis, r);
                    grad = cross.dot(err);
                } else {
                    grad = zAxis.dot(err);
                }
                q[i] += grad * lr;
            }
        }
        q = q.map((v, idx) => {
            if(this.dh[idx].type === 'r') {
                while(v > 180) v-=360; while(v < -180) v+=360; 
                return clamp(v, this.dh[idx].min, this.dh[idx].max);
            }
            return clamp(v, this.dh[idx].min, this.dh[idx].max);
        });
        return q;
    },

    liveIK: function() {
        const x = parseFloat(document.getElementById('ik-x').value) || 0;
        const y = parseFloat(document.getElementById('ik-y').value) || 0;
        const z = parseFloat(document.getElementById('ik-z').value) || 0;
        const target = new THREE.Vector3(x,y,z);
        View.updateGhost(target);
        this.targetJoints = this.solveIK(target);
        UI.updateSliders();
    },

    jogInterval: null,
    startJog: function(axis, amount) {
        if(this.jogInterval) clearInterval(this.jogInterval);
        this.jogInterval = setInterval(() => {
            const el = document.getElementById(`ik-${axis}`);
            let val = parseFloat(el.value) + amount;
            el.value = val.toFixed(2);
            this.liveIK();
        }, 30);
    },
    stopJog: function() { clearInterval(this.jogInterval); },

    setGripper: function(val) { this.gripper = parseFloat(val); },

    addLink: function() {
        this.dh.push({type:'r', d:0.2, a:0.2, alpha:0, offset:0, min:-180, max:180});
        this.joints.push(0); this.targetJoints.push(0);
        UI.buildDHTable(); UI.buildSliders(); View.rebuildRobotModel();
        UI.notify("Link Added", "ok");
    },
    
    removeLink: function() {
        if(this.dh.length > 2) {
            this.dh.pop(); this.joints.pop(); this.targetJoints.pop();
            UI.buildDHTable(); UI.buildSliders(); View.rebuildRobotModel();
            UI.notify("Link Removed", "warn");
        }
    },
    
    rebuild: function() {
        View.rebuildRobotModel();
        UI.notify("Kinematics Updated", "ok");
    }
};

const Hardware = {
    port: null,
    writer: null,
    connected: false,
    lastSync: 0,
    syncInterval: 40, // ~25Hz for high responsiveness

    async connect() {
        if (!("serial" in navigator)) {
            UI.notify("Web Serial API not supported in this browser.", "err");
            return;
        }
        try {
            this.port = await navigator.serial.requestPort();
            const baud = parseInt(document.getElementById('baud-rate').value);
            await this.port.open({ baudRate: baud });
            this.writer = this.port.writable.getWriter();
            this.connected = true;
            this.updateUI(true);
            UI.notify("Hardware Connected", "ok");
        } catch (err) {
            console.error(err);
            UI.notify("Connection Failed", "err");
        }
    },

    async disconnect() {
        if (this.writer) { await this.writer.releaseLock(); this.writer = null; }
        if (this.port) { await this.port.close(); this.port = null; }
        this.connected = false;
        this.updateUI(false);
        UI.notify("Hardware Disconnected", "warn");
    },

    updateUI(isConnected) {
        const dot = document.getElementById('hw-dot');
        const text = document.getElementById('hw-status-text');
        const btnConnect = document.getElementById('btn-hw-connect');
        const btnDisconnect = document.getElementById('btn-hw-disconnect');
        if (isConnected) {
            dot.classList.add('connected');
            text.innerText = "CONNECTED";
            btnConnect.style.display = "none";
            btnDisconnect.style.display = "block";
        } else {
            dot.classList.remove('connected');
            text.innerText = "DISCONNECTED";
            btnConnect.style.display = "block";
            btnDisconnect.style.display = "none";
        }
    },

    async sync(joints) {
        if (!this.connected || !this.writer) return;
        const now = Date.now();
        if (now - this.lastSync < this.syncInterval) return;
        try {
            const data = joints.map(j => j.toFixed(2)).join(',') + '\n';
            const encoder = new TextEncoder();
            await this.writer.write(encoder.encode(data));
            this.lastSync = now;
        } catch (err) {
            this.disconnect();
        }
    }
};

const View = {
    scene: null, camera: null, renderer: null, controls: null,
    meshes: { parts: [], gripper: null, ghost: null, trail: null, frames: [], fingers: [] },
    showFrames: false, recordingTrail: true,
    
    init: function() {
        const el = document.getElementById('viewport');
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(45, el.clientWidth/el.clientHeight, 0.1, 100);
        this.camera.position.set(3, 2.5, 3);
        
        this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        this.renderer.setSize(el.clientWidth, el.clientHeight);
        this.renderer.shadowMap.enabled = true;
        this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        el.appendChild(this.renderer.domElement);
        
        this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
        this.controls.enableDamping = true;
        this.controls.target.set(0, 0.5, 0);
        
        this.buildMaterials();
        this.buildEnvironment();
        window.addEventListener('resize', () => this.onResize());
        this.animate();
    },

    materials: {},
    buildMaterials: function() {
        this.materials.body = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.2, metalness: 0.8 });
        this.materials.joint = new THREE.MeshStandardMaterial({ color: 0xff9100, roughness: 0.4, metalness: 0.5, emissive: 0xff4400, emissiveIntensity: 0.1 });
        this.materials.link = new THREE.MeshStandardMaterial({ color: 0x444444, roughness: 0.7, metalness: 0.2 });
        this.materials.ghost = new THREE.MeshBasicMaterial({ color: 0xff9100, wireframe: true, transparent: true, opacity: 0.2 });
    },

    buildEnvironment: function() {
        const grid = new THREE.GridHelper(20, 20, 0x333333, 0x111111);
        this.scene.add(grid);
        const floorGeo = new THREE.PlaneGeometry(50, 50);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 0.1, metalness: 0.5 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI/2; floor.position.y = -0.01; floor.receiveShadow = true;
        this.scene.add(floor);
        this.scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const spot = new THREE.SpotLight(0xffffff, 1.5);
        spot.position.set(5, 8, 5); spot.castShadow = true; spot.shadow.mapSize.width = 1024; spot.shadow.mapSize.height = 1024;
        this.scene.add(spot);
        const rim = new THREE.PointLight(0xff9100, 0.5);
        rim.position.set(-5, 2, -5); this.scene.add(rim);
        this.meshes.ghost = new THREE.Mesh(new THREE.SphereGeometry(0.05, 16, 16), this.materials.ghost);
        this.scene.add(this.meshes.ghost);
        const trailGeo = new THREE.BufferGeometry();
        const positions = new Float32Array(5000 * 3); 
        trailGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        const trailMat = new THREE.LineBasicMaterial({ color: 0xff9100, transparent: true, opacity: 0.5 });
        this.meshes.trail = new THREE.Line(trailGeo, trailMat);
        this.meshes.trail.frustumCulled = false;
        this.meshes.trail.geometry.setDrawRange(0, 0);
        this.scene.add(this.meshes.trail);
    },

    rebuildRobotModel: function() {
        if (this.meshes.parts) this.meshes.parts.forEach(p => this.scene.remove(p.mesh));
        if (this.meshes.frames) this.meshes.frames.forEach(f => this.scene.remove(f));
        if (this.meshes.gripper) this.scene.remove(this.meshes.gripper);
        this.meshes.parts = []; this.meshes.frames = [];
        const bf = new THREE.AxesHelper(0.15); bf.visible = this.showFrames;
        this.scene.add(bf); this.meshes.frames.push(bf);
        for(let i=0; i<Robot.dh.length; i++) {
            const hubGeo = new THREE.CylinderGeometry(0.08, 0.08, 0.12, 16);
            hubGeo.rotateX(Math.PI/2);
            const hub = new THREE.Mesh(hubGeo, this.materials.joint);
            hub.castShadow = true; this.scene.add(hub);
            this.meshes.parts.push({ type:'joint', mesh:hub });
            const linkGeo = new THREE.BoxGeometry(0.06, 0.06, 1);
            linkGeo.translate(0, 0, 0.5); 
            const link = new THREE.Mesh(linkGeo, this.materials.link);
            link.castShadow = true; this.scene.add(link);
            this.meshes.parts.push({ type:'link', mesh:link });
            const frame = new THREE.AxesHelper(0.15); frame.visible = this.showFrames;
            this.scene.add(frame); this.meshes.frames.push(frame);
        }
        const grip = new THREE.Group();
        const base = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 0.04), this.materials.body);
        grip.add(base);
        const finger1 = new THREE.Mesh(new THREE.BoxGeometry(0.02, 0.08, 0.02), this.materials.joint);
        finger1.position.set(0.03, 0, 0.06); grip.add(finger1);
        const finger2 = new THREE.Mesh(new THREE.BoxGeometry(0.02, 0.08, 0.02), this.materials.joint);
        finger2.position.set(-0.03, 0, 0.06); grip.add(finger2);
        this.scene.add(grip);
        this.meshes.gripper = grip;
        this.meshes.fingers = [finger1, finger2];
    },

    updateGhost: function(pos) { if(this.meshes.ghost) this.meshes.ghost.position.copy(pos); },
    updateColor: function(type, hex) { if(this.materials[type]) this.materials[type].color.set(hex); },
    toggleFrames: function() { this.showFrames = !this.showFrames; this.meshes.frames.forEach(f => f.visible = this.showFrames); UI.notify(this.showFrames ? "Frames Visible" : "Frames Hidden", "ok"); },
    toggleTrailRecord: function() { this.recordingTrail = !this.recordingTrail; UI.notify(this.recordingTrail ? "Path Recording ON" : "Path Recording PAUSED", "ok"); },
    clearTrail: function() { this.trailCount = 0; this.meshes.trail.geometry.setDrawRange(0, 0); },

    trailCount: 0,
    updateVisuals: function(chain) {
        this.meshes.frames.forEach((f, i) => {
            f.position.copy(chain[i].pos);
            f.quaternion.setFromRotationMatrix(chain[i].mat);
        });
        for(let i=0; i<Robot.dh.length; i++) {
            const start = chain[i].pos;
            const end = chain[i+1].pos;
            const jointMesh = this.meshes.parts[i*2].mesh;
            jointMesh.position.copy(start);
            jointMesh.quaternion.setFromRotationMatrix(chain[i].mat);
            const linkMesh = this.meshes.parts[i*2+1].mesh;
            const dist = start.distanceTo(end);
            if(dist > 0.001) {
                linkMesh.visible = true;
                linkMesh.position.copy(start);
                linkMesh.lookAt(end);
                linkMesh.scale.z = dist;
            } else linkMesh.visible = false;
        }
        const tcpFrame = chain[chain.length-1];
        if(this.meshes.gripper) {
            this.meshes.gripper.position.copy(tcpFrame.pos);
            this.meshes.gripper.quaternion.setFromRotationMatrix(tcpFrame.mat);
            const gap = 0.02 + (Robot.gripper * 0.02);
            this.meshes.fingers[0].position.x = gap;
            this.meshes.fingers[1].position.x = -gap;
        }
        if(this.recordingTrail && this.trailCount < 5000) {
            const tcp = tcpFrame.pos;
            const positions = this.meshes.trail.geometry.attributes.position.array;
            let shouldAdd = true;
            if (this.trailCount > 0) {
                const lx = positions[(this.trailCount-1)*3], ly = positions[(this.trailCount-1)*3+1], lz = positions[(this.trailCount-1)*3+2];
                const d = (tcp.x-lx)**2 + (tcp.y-ly)**2 + (tcp.z-lz)**2;
                if(d < 0.0001) shouldAdd = false;
            }
            if(shouldAdd) {
                positions[this.trailCount * 3] = tcp.x; positions[this.trailCount * 3 + 1] = tcp.y; positions[this.trailCount * 3 + 2] = tcp.z;
                this.trailCount++;
                this.meshes.trail.geometry.attributes.position.needsUpdate = true;
                this.meshes.trail.geometry.setDrawRange(0, this.trailCount);
            }
        }
        Plotter.push(tcpFrame.pos.x, tcpFrame.pos.y, tcpFrame.pos.z);
        document.getElementById('hud-tcp').innerText = `${tcpFrame.pos.x.toFixed(2)}, ${tcpFrame.pos.y.toFixed(2)}, ${tcpFrame.pos.z.toFixed(2)}`;
    },

    animate: function() {
        requestAnimationFrame(() => this.animate());
        let maxVel = 0;
        for(let i=0; i<Robot.joints.length; i++) {
            const diff = Robot.targetJoints[i] - Robot.joints[i];
            // Increase interpolation speed to 0.4 for near-instant "simultaneous" feel
            if(Math.abs(diff) > 0.01) {
                const step = diff * 0.4; 
                Robot.joints[i] += step; 
                maxVel = Math.max(maxVel, Math.abs(step));
            } else Robot.joints[i] = Robot.targetJoints[i];
        }
        
        const chain = Robot.forwardKinematics(Robot.joints);
        this.updateVisuals(chain);
        this.controls.update();
        this.renderer.render(this.scene, this.camera);
        
        Telemetry.push(maxVel);
        document.getElementById('hud-vel').innerText = (maxVel * 60).toFixed(1) + " deg/s";

        // Sync hardware simultaneously with simulation movement
        if (Hardware.connected) {
            Hardware.sync(Robot.joints);
        }
        
        if(Env.crate) {
            const tcp = chain[chain.length-1].pos;
            if(Robot.gripper > 0.8 && !Robot.holdingObject) {
                if(tcp.distanceTo(Env.crate.position) < 0.15) { 
                    Robot.holdingObject = Env.crate; 
                    this.meshes.gripper.attach(Env.crate); 
                    UI.notify("Object Captured", "ok");
                }
            } else if(Robot.gripper < 0.5 && Robot.holdingObject) { 
                this.scene.attach(Env.crate); 
                Robot.holdingObject = null; 
                UI.notify("Object Released", "warn");
            }
        }
    },
    
    onResize: function() {
        const el = document.getElementById('viewport');
        this.camera.aspect = el.clientWidth/el.clientHeight;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(el.clientWidth, el.clientHeight);
    }
};

const Plotter = {
    canvas: null, ctx: null, dataX: [], dataY: [], dataZ: [], paused: false,
    init: function() { 
        this.canvas = document.getElementById('plot-canvas'); 
        if(!this.canvas) return; 
        this.ctx = this.canvas.getContext('2d'); 
    },
    push: function(x, y, z) {
        if(this.paused) return;
        if(!this.ctx) this.init();
        this.dataX.push(x); this.dataY.push(y); this.dataZ.push(z);
        if(this.dataX.length > 200) { this.dataX.shift(); this.dataY.shift(); this.dataZ.shift(); }
        this.draw();
    },
    togglePause: function() { this.paused = !this.paused; },
    clear: function() { this.dataX = []; this.dataY = []; this.dataZ = []; },
    draw: function() {
        const cvs = this.canvas; const ctx = this.ctx;
        if(cvs.width !== cvs.offsetWidth || cvs.height !== cvs.offsetHeight) { cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight; }
        const w = cvs.width; const h = cvs.height;
        ctx.fillStyle = '#050505'; ctx.fillRect(0,0,w,h);
        ctx.strokeStyle = '#222'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
        this.drawSeries(this.dataX, '#ff4444', w, h); 
        this.drawSeries(this.dataY, '#44ff44', w, h); 
        this.drawSeries(this.dataZ, '#4444ff', w, h);
    },
    drawSeries: function(data, color, w, h) {
        if(data.length < 2) return;
        const ctx = this.ctx; ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 1.5;
        const scale = h/4; const mid = h/2; const step = w / 200;
        for(let i=0; i<data.length; i++) { 
            const x = i * step; 
            const y = mid - (data[i] * scale); 
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); 
        }
        ctx.stroke();
    }
};

const AI = {
    generateScript: async function() {
        const prompt = document.getElementById('ai-prompt').value;
        if(!prompt) return UI.notify("Please enter a command", "err");
        UI.notify("Consulting Gemini...", "warn");
        const cratePos = Env.crate ? `${Env.crate.position.x.toFixed(2)}, ${Env.crate.position.y.toFixed(2)}, ${Env.crate.position.z.toFixed(2)}` : "None";
        const systemPrompt = `You are a robotic programming assistant. Convert the user command into RevoScript. Base at [0,0,0]. Crate at [${cratePos}].
        Syntax: SPEED <0-100>, MOVE <x> <y> <z>, GRIP <0|1>, WAIT <ms>, HOME. Code ONLY.`;
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
            });
            const data = await response.json();
            let code = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (code) {
                code = code.replace(/```(revo|script)?/gi, '').replace(/```/g, '').trim();
                document.getElementById('script-area').value = "// Generated by Gemini ✨\n" + code;
                UI.notify("Script Generated!", "ok"); UI.switchTab('script');
            } else throw new Error();
        } catch (e) { UI.notify("API Offline", "err"); }
    }
};

const Script = {
    running: false, lines: [], pc: 0,
    run: function() { 
        if(this.running) return; 
        this.lines = document.getElementById('script-area').value.split('\n'); 
        this.pc = 0; this.running = true; 
        UI.notify("Script Started", "ok"); 
        this.step(); 
    },
    stop: function() { this.running = false; UI.notify("Script Halted", "err"); },
    step: function() {
        if(!this.running || this.pc >= this.lines.length) { this.running = false; return; }
        const line = this.lines[this.pc].trim(); this.pc++;
        if(!line || line.startsWith('//')) { this.step(); return; }
        const parts = line.split(/\s+/); const cmd = parts[0].toUpperCase();
        switch(cmd) {
            case 'MOVE': 
                const x = parseFloat(parts[1]), y = parseFloat(parts[2]), z = parseFloat(parts[3]);
                Robot.targetJoints = Robot.solveIK(new THREE.Vector3(x,y,z));
                View.updateGhost(new THREE.Vector3(x,y,z));
                UI.updateSliders();
                setTimeout(() => this.step(), 1000); 
                break;
            case 'WAIT': setTimeout(() => this.step(), parseInt(parts[1])); break;
            case 'GRIP': Robot.setGripper(parseFloat(parts[1])); setTimeout(() => this.step(), 400); break;
            case 'HOME': 
                Robot.targetJoints = new Array(Robot.dh.length).fill(0); 
                UI.updateSliders();
                setTimeout(() => this.step(), 1000); 
                break;
            default: this.step();
        }
    }
};

const Env = {
    crate: null, tent: null,
    spawnCrate: function() {
        if(this.crate) View.scene.remove(this.crate);
        const geo = new THREE.BoxGeometry(0.12, 0.12, 0.12); 
        const mat = new THREE.MeshStandardMaterial({ color: 0xff9100, roughness: 0.5 });
        this.crate = new THREE.Mesh(geo, mat); this.crate.position.set(1.0, 0.06, 0.5); 
        this.crate.castShadow = true; View.scene.add(this.crate);
        UI.notify("Crate Spawned", "ok");
    },
    toggleWorkspace: function() {
        if(this.tent) { View.scene.remove(this.tent); this.tent = null; return; }
        UI.notify("Calculating Work Volume...", "warn");
        setTimeout(() => {
            const points = [];
            for(let i=0; i<3000; i++) {
                const q = Robot.dh.map(p => (Math.random()*(p.max-p.min) + p.min));
                const chain = Robot.forwardKinematics(q);
                const pos = chain[chain.length-1].pos;
                if(pos.y >= 0) points.push(pos);
            }
            if(points.length > 4) {
                const geom = new THREE.ConvexGeometry(points); geom.computeVertexNormals();
                const mat = new THREE.MeshPhongMaterial({ color: 0xff9100, transparent: true, opacity: 0.1, side: THREE.DoubleSide });
                this.tent = new THREE.Mesh(geom, mat); View.scene.add(this.tent); 
                UI.notify("Hull Generated", "ok");
            }
        }, 50);
    }
};

const UI = {
    switchTab: function(id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.toLowerCase() === id);
        if(btn) btn.classList.add('active');
        document.getElementById(`tab-${id}`).classList.add('active');
        if(id === 'code') CodeGen.generate();
    },
    buildDHTable: function() {
        const tbody = document.querySelector('#dh-table tbody'); tbody.innerHTML = '';
        Robot.dh.forEach((p, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${p.type.toUpperCase()}</td><td><input type="number" value="${p.d}" onchange="Robot.dh[${i}].d=parseFloat(this.value); Robot.rebuild()"></td><td><input type="number" value="${p.a}" onchange="Robot.dh[${i}].a=parseFloat(this.value); Robot.rebuild()"></td><td><input type="number" value="${p.alpha}" onchange="Robot.dh[${i}].alpha=parseFloat(this.value); Robot.rebuild()"></td><td><input type="number" value="${p.offset}" onchange="Robot.dh[${i}].offset=parseFloat(this.value)"></td>`;
            tbody.appendChild(tr);
        });
    },
    buildSliders: function() {
        const div = document.getElementById('joint-sliders'); div.innerHTML = '';
        Robot.dh.forEach((p, i) => {
            const row = document.createElement('div'); row.className = 'control-section'; row.style.padding = '10px';
            row.innerHTML = `<div class="row"><label>Joint ${i+1}</label><span style="font-size:10px; color:#ff9100" id="val-j${i}">0°</span></div><input type="range" min="${p.min}" max="${p.max}" value="0" step="0.5" oninput="Robot.targetJoints[${i}]=parseFloat(this.value); document.getElementById('val-j${i}').innerText=this.value+'°'">`;
            div.appendChild(row);
        });
    },
    updateSliders: function() {
        Robot.targetJoints.forEach((v, i) => { 
            const slider = document.querySelector(`#joint-sliders .control-section:nth-of-type(${i+1}) input`);
            if(slider) slider.value = v;
            const valLabel = document.getElementById(`val-j${i}`);
            if(valLabel) valLabel.innerText = Math.round(v) + '°';
        });
    },
    notify: function(msg, type) {
        const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg;
        if(type==='err') t.style.borderColor = '#ff1744'; if(type==='ok') t.style.borderColor = '#00e676';
        document.getElementById('toast-area').appendChild(t); setTimeout(() => t.remove(), 3000);
    }
};

const Telemetry = {
    data: [],
    push: function(val) { this.data.push(val); if(this.data.length > 200) this.data.shift(); this.draw(); },
    draw: function() {
        const cvs = document.getElementById('telemetry'); if(!cvs) return;
        const ctx = cvs.getContext('2d');
        const w = cvs.width = cvs.offsetWidth; const h = cvs.height = cvs.offsetHeight;
        ctx.fillStyle = '#0f0f0f'; ctx.fillRect(0,0,w,h); ctx.strokeStyle = '#ff9100'; ctx.lineWidth = 1.5; ctx.beginPath();
        for(let i=0; i<this.data.length; i++) { const x = (i/200)*w; const y = h - (this.data[i] * h * 6); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
        ctx.stroke();
    }
};

const CodeGen = {
    generate: function() {
        const lang = document.getElementById('code-lang').value;
        const txt = lang === 'cpp' ? this.cpp() : this.py();
        document.getElementById('export-area').value = txt;
    },
    copy: function() { document.getElementById('export-area').select(); document.execCommand('copy'); UI.notify("Code Copied", "ok"); },
    cpp: function() { return `// ARC Driver C++\nconst float dh[${Robot.dh.length}][4] = {\n` + Robot.dh.map(p => `  {${p.d}, ${p.a}, ${p.alpha}, ${p.offset}}`).join(',\n') + `\n};`; },
    py: function() { return `import numpy as np\ndh = [\n` + Robot.dh.map(p => `    [${p.d}, ${p.a}, ${p.alpha}, ${p.offset}]`).join(',\n') + `\n]`; }
};

const Sim = {
    loadPreset: function(p) { Robot.init(p); UI.notify(`Loaded ${p.toUpperCase()}`, "ok"); },
    resetCamera: function() { View.controls.reset(); },
    hardReset: function() { location.reload(); }
};

window.onload = function() { View.init(); Robot.init('simple'); Env.spawnCrate(); };
</script>
</body>
</html>
